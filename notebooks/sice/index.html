<!DOCTYPE html><html lang="en" class="" style="scroll-padding:60px"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Sentinel-3 Snow and ICE products (SICE) - PolarTEP Notebooks</title><meta property="og:title" content="Sentinel-3 Snow and ICE products (SICE) - PolarTEP Notebooks"/><meta name="generator" content="mystmd"/><meta name="description" content="Collection of examples relevant to the PolarTEP"/><meta property="og:description" content="Collection of examples relevant to the PolarTEP"/><meta name="keywords" content=""/><link rel="stylesheet" href="/polartep_notebooks/build/_assets/app-MOQGDXHO.css"/><link rel="stylesheet" href="/polartep_notebooks/build/_assets/thebe-core-VKVHG5VY.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jupyter-matplotlib@0.11.3/css/mpl_widget.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous"/><link rel="icon" href="/polartep_notebooks/favicon.ico"/><link rel="stylesheet" href="/polartep_notebooks/myst-theme.css"/><script>
  const savedTheme = localStorage.getItem("myst:theme");
  const theme = window.matchMedia("(prefers-color-scheme: light)").matches ? 'light' : 'dark';
  const classes = document.documentElement.classList;
  const hasAnyTheme = classes.contains('light') || classes.contains('dark');
  if (!hasAnyTheme) classes.add(savedTheme ?? theme);
</script></head><body class="m-0 transition-colors duration-500 bg-white dark:bg-stone-900"><div class="myst-skip-to-article fixed top-1 left-1 h-[0px] w-[0px] focus-within:z-40 focus-within:h-auto focus-within:w-auto bg-white overflow-hidden focus-within:p-2 focus-within:ring-1" aria-label="skip to content options"><a href="#skip-to-frontmatter" class="myst-skip-to-link block px-2 py-1 text-black underline">Skip to article frontmatter</a><a href="#skip-to-article" class="myst-skip-to-link block px-2 py-1 text-black underline">Skip to article content</a></div><dialog id="myst-no-css" style="position:fixed;left:0px;top:0px;width:100vw;height:100vh;font-size:4rem;padding:1rem;color:black;background:white"><strong>Site not loading correctly?</strong><p>This may be due to an incorrect <code>BASE_URL</code> configuration. See<!-- --> <a href="https://mystmd.org/guide/deployment#deploy-base-url">the MyST Documentation</a> <!-- -->for reference.</p><script>
    (() => {
            // Test for has-styling variable set by the MyST stylesheet
            const node = document.currentScript.parentNode;
            const hasCSS = window.getComputedStyle(node).getPropertyValue("--has-styling");
            if (hasCSS === ""){
                    node.showModal();
            }

    })()
</script></dialog><div class="myst-top-nav bg-white/80 backdrop-blur dark:bg-stone-900/80 shadow dark:shadow-stone-700 p-3 md:px-8 sticky w-screen top-0 z-30 h-[60px]"><nav class="myst-top-nav-bar flex items-center justify-between flex-nowrap max-w-[1440px] mx-auto"><div class="flex flex-row xl:min-w-[19.5rem] mr-2 sm:mr-7 justify-start items-center shrink-0"><div class="block lg:hidden"><button class="myst-top-nav-menu-button flex items-center justify-center border-stone-400 text-stone-800 hover:text-stone-900 dark:text-stone-200 hover:dark:text-stone-100 w-10 h-10"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" width="1.5rem" height="1.5rem"><path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd"></path></svg><span class="sr-only">Open Menu</span></button></div><a class="myst-home-link flex items-center ml-3 dark:text-white w-fit md:ml-5 xl:ml-7" href="/polartep_notebooks/"><span class="text-md sm:text-xl tracking-tight sm:mr-5">Made with MyST</span></a></div><div class="flex items-center flex-grow w-auto"><div class="flex-grow hidden text-md lg:block"></div><div class="flex-grow block"></div><button type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-:R75cp:" data-state="closed" class="myst-search-bar flex items-center h-10 aspect-square sm:w-64 text-left text-gray-600 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 myst-search-bar-disabled hover:ring-blue-500 dark:hover:ring-blue-500 hover:border-blue-500 dark:hover:border-blue-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="p-2.5 h-10 w-10 aspect-square"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd"></path></svg><span class="myst-search-text-placeholder hidden sm:block grow">Search</span><div aria-hidden="true" class="myst-search-shortcut items-center hidden mx-1 font-mono text-sm text-gray-600 dark:text-gray-300 sm:flex gap-x-1"><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none hide-mac">CTRL</kbd><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none show-mac">âŒ˜</kbd><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none ">K</kbd><script>
;(() => {
const script = document.currentScript;
const root = script.parentElement;

const isMac = /mac/i.test(
      window.navigator.userAgentData?.platform ?? window.navigator.userAgent,
    );
root.querySelectorAll(".hide-mac").forEach(node => {node.classList.add(isMac ? "hidden" : "block")});
root.querySelectorAll(".show-mac").forEach(node => {node.classList.add(!isMac ? "hidden" : "block")});
})()</script></div></button><button class="myst-theme-button theme rounded-full aspect-square border border-stone-700 dark:border-white hover:bg-neutral-100 border-solid overflow-hidden text-stone-700 dark:text-white hover:text-stone-500 dark:hover:text-neutral-800 w-10 h-10 mx-3" title="Toggle theme between light and dark mode" aria-label="Toggle theme between light and dark mode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="myst-theme-moon-icon h-full w-full p-0.5 hidden dark:block"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z" clip-rule="evenodd"></path></svg><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="myst-theme-sun-icon h-full w-full p-0.5 dark:hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"></path></svg></button><div class="block sm:hidden"></div><div class="hidden sm:block"></div></div></nav></div><div class="myst-primary-sidebar fixed xl:article-grid grid-gap xl:w-screen xl:pointer-events-none overflow-auto max-xl:min-w-[300px] lg:hidden hidden z-10" style="top:60px"><div class="myst-primary-sidebar-pointer pointer-events-auto xl:col-margin-left flex-col overflow-hidden hidden xl:flex"><div class="myst-primary-sidebar-nav flex-grow py-6 overflow-y-auto primary-scrollbar"><nav aria-label="Navigation" class="myst-primary-sidebar-topnav overflow-y-hidden transition-opacity ml-3 xl:ml-0 mr-3 max-w-[350px] lg:hidden"><div class="w-full px-1 dark:text-white font-medium"></div></nav></div></div></div><main class="article-grid grid-gap"><article class="article-grid subgrid-gap col-screen article content"><div class="hidden"></div><div id="skip-to-frontmatter" aria-label="article frontmatter" class="myst-fm-block mb-8 pt-9"><div class="myst-fm-block-header flex items-center mb-5 h-6 text-sm font-light"><div class="myst-fm-block-subject flex-none pr-2 smallcaps">Notebook examples</div><div class="flex-grow"></div><div class="myst-fm-block-badges"><a href="https://github.com/gtif-cerulean/polartep_notebooks" title="GitHub Repository: gtif-cerulean/polartep_notebooks" target="_blank" rel="noopener noreferrer" class="myst-fm-github-link text-inherit hover:text-inherit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="1.25rem" height="1.25rem" class="myst-fm-github-icon inline-block mr-1 opacity-60 hover:opacity-100"><path d="M12 2.5c-5.4 0-9.8 4.4-9.8 9.7 0 4.3 2.8 8 6.7 9.2.5.1.7-.2.7-.5v-1.8c-2.4.5-3.1-.6-3.3-1.1-.1-.3-.6-1.1-1-1.4-.3-.2-.8-.6 0-.6s1.3.7 1.5 1c.9 1.5 2.3 1.1 2.8.8.1-.6.3-1.1.6-1.3-2.2-.2-4.4-1.1-4.4-4.8 0-1.1.4-1.9 1-2.6-.1-.2-.4-1.2.1-2.6 0 0 .8-.3 2.7 1 .8-.2 1.6-.3 2.4-.3.8 0 1.7.1 2.4.3 1.9-1.3 2.7-1 2.7-1 .5 1.3.2 2.3.1 2.6.6.7 1 1.5 1 2.6 0 3.7-2.3 4.6-4.4 4.8.4.3.7.9.7 1.8V21c0 .3.2.6.7.5 3.9-1.3 6.6-4.9 6.6-9.2 0-5.4-4.4-9.8-9.8-9.8z"></path></svg></a></div><a href="https://github.com/gtif-cerulean/polartep_notebooks/edit/main/notebooks/SICE.ipynb" title="Edit This Page" target="_blank" rel="noopener noreferrer" class="myst-fm-edit-link text-inherit hover:text-inherit"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.25rem" height="1.25rem" class="myst-fm-edit-icon inline-block mr-1 opacity-60 hover:opacity-100"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"></path></svg></a><div class="myst-fm-downloads-dropdown relative flex inline-block mx-1 grow-0" data-headlessui-state=""><button class="myst-fm-downloads-button relative ml-2 -mr-1" id="headlessui-menu-button-:Rs8ucp:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Downloads</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.25rem" height="1.25rem" class="myst-fm-downloads-icon"><title>Download</title><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg></button></div></div><h1 class="myst-fm-block-title mb-0">Sentinel-3 Snow and ICE products (SICE)</h1></div><div class="block my-10 lg:sticky lg:z-10 lg:h-0 lg:pt-0 lg:my-0 lg:ml-10 lg:col-margin-right" style="top:60px"><nav></nav></div><div id="skip-to-article"></div><div id="fmtiNwEvCL" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">#%run ./prepare-sice-environment.ipynb
! pip install --upgrade sentinelhub </code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="9_-JQ8CC5kPBJNFbVLgqs" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>Defaulting to user installation because normal site-packages is not writeable
Requirement already satisfied: sentinelhub in ./.local/lib/python3.9/site-packages (3.8.4)
Requirement already satisfied: aenum&gt;=2.1.4 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (3.1.11)
Requirement already satisfied: requests-oauthlib&gt;=1.0.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (1.3.1)
Requirement already satisfied: numpy in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (1.23.5)
Requirement already satisfied: typing-extensions in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (4.4.0)
Requirement already satisfied: tifffile&gt;=2020.9.30 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (2022.10.10)
Requirement already satisfied: shapely in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (1.8.5.post1)
Requirement already satisfied: oauthlib in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (3.2.2)
Requirement already satisfied: tqdm in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (4.64.1)
Requirement already satisfied: requests&gt;=2.27.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (2.28.1)
Requirement already satisfied: python-dateutil in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (2.8.2)
Requirement already satisfied: utm in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (0.7.0)
Requirement already satisfied: dataclasses-json in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (0.5.7)
Requirement already satisfied: pillow&gt;=9.2.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (9.2.0)
Requirement already satisfied: click in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (8.0.4)
Requirement already satisfied: pyproj&gt;=2.2.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (3.4.0)
Requirement already satisfied: certifi in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from pyproj&gt;=2.2.0-&gt;sentinelhub) (2022.9.24)
Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from requests&gt;=2.27.0-&gt;sentinelhub) (1.26.13)
Requirement already satisfied: charset-normalizer&lt;3,&gt;=2 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from requests&gt;=2.27.0-&gt;sentinelhub) (2.1.1)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from requests&gt;=2.27.0-&gt;sentinelhub) (3.4)
Requirement already satisfied: marshmallow-enum&lt;2.0.0,&gt;=1.5.1 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from dataclasses-json-&gt;sentinelhub) (1.5.1)
Requirement already satisfied: marshmallow&lt;4.0.0,&gt;=3.3.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from dataclasses-json-&gt;sentinelhub) (3.19.0)
Requirement already satisfied: typing-inspect&gt;=0.4.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from dataclasses-json-&gt;sentinelhub) (0.8.0)
Requirement already satisfied: six&gt;=1.5 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from python-dateutil-&gt;sentinelhub) (1.16.0)
Requirement already satisfied: packaging&gt;=17.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from marshmallow&lt;4.0.0,&gt;=3.3.0-&gt;dataclasses-json-&gt;sentinelhub) (21.3)
Requirement already satisfied: mypy-extensions&gt;=0.3.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from typing-inspect&gt;=0.4.0-&gt;dataclasses-json-&gt;sentinelhub) (0.4.3)
Requirement already satisfied: pyparsing!=3.0.5,&gt;=2.0.2 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from packaging&gt;=17.0-&gt;marshmallow&lt;4.0.0,&gt;=3.3.0-&gt;dataclasses-json-&gt;sentinelhub) (3.0.9)
</span></code></pre></div></div></div></div><div id="akMoF5ezv4" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">
## Credentials needs to be filled in the code in order to make it work!

import matplotlib.pyplot as plt
import numpy as np
import os
import logging
import subprocess
from botocore.client import Config as botoConfig
from botocore.exceptions import ClientError
from oauthlib.oauth2 import BackendApplicationClient
from requests_oauthlib import OAuth2Session
import boto3
import glob
import time
import rasterio
from shapely import geometry
from osgeo import ogr

logging = logging.getLogger(__name__)

def plot_image(image, factor=1.0, clip_range=None, **kwargs):
    &quot;&quot;&quot;
    Utility function for plotting RGB images.
    &quot;&quot;&quot;
    fig, ax = plt.subplots(nrows=1, ncols=1, figsize=(15, 15))
    if clip_range is not None:
        ax.imshow(np.clip(image * factor, *clip_range), **kwargs)
    else:
        ax.imshow(image * factor, **kwargs)
    ax.set_xticks([])
    ax.set_yticks([])
    
    
def merge_tiffs(input_filename_list, merged_filename, *, overwrite=False, delete_input=False):
    &quot;&quot;&quot;Performs gdal_merge on a set of given geotiff images

    :param input_filename_list: A list of input tiff image filenames
    :param merged_filename: Filename of merged tiff image
    :param overwrite: If True overwrite the output (merged) file if it exists
    :param delete_input: If True input images will be deleted at the end
    &quot;&quot;&quot;
    if os.path.exists(merged_filename):
        if overwrite:
            os.remove(merged_filename)
        else:
            raise OSError(f&quot;{merged_filename} exists!&quot;)

    logging.info(&quot;merging %d tiffs to %s&quot;, len(input_filename_list), merged_filename)
    subprocess.check_call(
        [&quot;gdal_merge.py&quot;, &quot;-co&quot;, &quot;BIGTIFF=YES&quot;, &quot;-co&quot;, &quot;compress=LZW&quot;, &quot;-ot&quot;, &quot;Float32&quot; , &quot;-init&quot;, &quot;-9999&quot; , &quot;-n&quot;, &quot;-9999&quot;, &quot;-a_nodata&quot;, &quot;-9999&quot;, &quot;-o&quot;, merged_filename, *input_filename_list]
    )
    logging.info(&quot;merging done&quot;)

    if delete_input:
        logging.info(&quot;deleting input files&quot;)
        for filename in input_filename_list:
            if os.path.isfile(filename):
                os.remove(filename)
                
def deleteProcessingData(dir):
    logging.info(f&#x27;Deleting files from {dir}&#x27;)
    for file in glob.glob(f&#x27;{dir}/*_tmp.tif&#x27;):
        logging.info(f&#x27;Deleting file {file}&#x27;)
        os.remove(file)

def importToBucket(awsConfig, resultsFolder, processBands=False):
    
    try:
        s3_client = boto3.resource(&#x27;s3&#x27;,
                                   endpoint_url=awsConfig[&#x27;s3Url&#x27;],
                                   use_ssl=False,
                                   aws_access_key_id=awsConfig[&#x27;s3AccessKey&#x27;],
                                   aws_secret_access_key=awsConfig[&#x27;s3SecrestKey&#x27;],
                                   config=botoConfig(
                                       signature_version=&#x27;s3&#x27;,
                                       connect_timeout=60,
                                       read_timeout=60,
                                   ))

        bucket = s3_client.Bucket(awsConfig[&#x27;bucketName&#x27;])
    except Exception as e:
        logging.error(e)
        raise Exception(&#x27;Invalid bucket parameters&#x27;) 
    
    coverGeometry = &#x27;&#x27;
    
    # get tif files to upload
    filenamesList = glob.glob(f&#x27;{resultsFolder}/*.tif&#x27;)
    try:
        for file in filenamesList:
            destFile = file.replace(resultsFolder, awsConfig[&#x27;folder&#x27;])
            if processBands:
                tmpFile = file.replace(&quot;.tif&quot;, &quot;_tmp.tif&quot;)
                cmd = &quot;gdal_translate -b 1 -of COG -a_nodata -9999 -co COMPRESS=DEFLATE -co BLOCKSIZE=1024 -co RESAMPLING=AVERAGE -co OVERVIEWS=IGNORE_EXISTING {0} {1}&quot;.format(file, tmpFile)
                logging.info(cmd)
                os.system(cmd)
                file = tmpFile
                
            if not coverGeometry:
                coverGeometry = getMbrWithIntermediate(file)
            
            logging.info(f&#x27;Uploading {file} to {destFile}&#x27;)
            response = bucket.upload_file(file, destFile)
        deleteProcessingData(resultsFolder)
    except Exception as e:
        logging.error(e)
        raise Exception(f&#x27;Failed to upload file: {destFile}&#x27;) 
        
    return coverGeometry

def addIntermediateY(x, y, diff, numPoints):
    coords = []
    coords.append([x, y])  
    for i in range(numPoints):
        coords.append([x, y + i / numPoints * diff])
    return coords

def addIntermediateX(x, y, diff, numPoints):
    coords = []
    coords.append([x, y])  
    for i in range(numPoints):
        coords.append([x + i / numPoints * diff, y])
    return coords

def getMbrWithIntermediate(file):
    dataset = rasterio.open(file)
    bounds = dataset.bounds
    poly = getPolygonFromMbr(bounds.left, bounds.bottom, bounds.right, bounds.top, 20)
    p = geometry.mapping(poly)
    p[&#x27;properties&#x27;] = {&#x27;name&#x27;: &#x27;urn:ogc:def:crs:EPSG::4326&#x27;}
    return p         
        
def getPolygonFromMbr(xMin, yMin, xMax, yMax, numPoints):
    coords = []
    xDiff = xMax - xMin
    yDiff = yMax - yMin
    
    coords.extend(addIntermediateY(xMin, yMin, yDiff, numPoints))
    coords.extend(addIntermediateX(xMin, yMax, xDiff, numPoints))
    coords.extend(addIntermediateY(xMax, yMax, -yDiff, numPoints))
    coords.extend(addIntermediateX(xMax, yMin, -xDiff, numPoints))
    poly = geometry.Polygon(coords)
    return poly        
        
def deleteTile(s3folder, oauth, byocUrl):
    url = f&#x27;{byocUrl}/tiles&#x27;

    try:
        while url is not None:
            print(f&#x27;Calling url: {url}&#x27;)
            response = oauth.get(url)
            response.raise_for_status()

            output = response.json()
            tiles = output[&#x27;data&#x27;]
            links = output[&#x27;links&#x27;]

            for tile in tiles:
                if tile[&#x27;path&#x27;].startswith(s3folder):
                    tile_id = tile[&#x27;id&#x27;]
                    response = oauth.delete(f&#x27;{byocUrl}/tiles/{tile_id}&#x27;)
                    print(&quot;Deleted tile: &quot; + tile[&#x27;path&#x27;])
                    try:
                        response.raise_for_status()
                    except Exception as e:
                        print(&quot;Failed to delete tile {0}: {1}&quot;.format(
                            tile_id, response.reason))
                        logging.error(e)

            # sets url to None if there&#x27;s no link to the next set of tiles
            url = links.get(&#x27;next&#x27;, None)

            # waits a bit before fetching the next set
            time.sleep(0.1)
    except Exception as e:
        logging.error(&quot;BYOC delete error: {0}&quot;.format(response.reason))
        logging.error(e)
        raise

def insertTile(tile, oauth, byocUrl):
    print(f&#x27;Inserting tile {tile}&#x27;)
    try:
        response = oauth.post(f&#x27;{byocUrl}/tiles&#x27;, json=tile)
        response.raise_for_status()
    except Exception as e:
        logging.error(&quot;BYOC import error: {0}&quot;.format(response.reason))
        logging.error(e)


def importToBYOC(config):
     # Create a session
    client = BackendApplicationClient(client_id=config[&#x27;client_id&#x27;])
    oauth = OAuth2Session(client=client)
    oauth.fetch_token(token_url=&#x27;https://services.sentinel-hub.com/oauth/token&#x27;,
                      client_id=[&#x27;client_id&#x27;], client_secret=config[&#x27;client_secret&#x27;])

    byoc_service_base_url = config[&#x27;byoc_service_base_url&#x27;]
    collection_id = config[&#x27;collection_id&#x27;]
    byocUrl = f&#x27;{byoc_service_base_url}/collections/{collection_id}&#x27;
    
    # ingest tile
    tilePath = config[&#x27;folder&#x27;]
    tile = {
        &#x27;path&#x27;: tilePath,
        &#x27;sensingTime&#x27;: config[&#x27;sensingTime&#x27;],
        &#x27;coverGeometry&#x27; : config[&#x27;coverGeometry&#x27;]
    }
    
    if config[&#x27;coverGeometry&#x27;]: 
         tile [&#x27;coverGeometry&#x27;] = config[&#x27;coverGeometry&#x27;]
            
    logging.info(&quot;Deleting folder: &quot; + tilePath)
    deleteTile(tilePath, oauth, byocUrl)
    logging.info(&quot;Ingesting folder: &quot; + tilePath)
    insertTile(tile, oauth, byocUrl)
    
    
def defaultBYOCImport(resultsFolder, s3Folder, resolution, sensingTime):
    if not (resolution == 300 or resolution == 500) :
        logger.info(&#x27;Resolution not supported.&#x27;)
        return
    
    s3config = {
        &#x27;s3Url&#x27; : &#x27;https://s3.waw2-1.cloudferro.com&#x27;,
        &#x27;s3AccessKey&#x27; : &#x27;xxx&#x27;,
        &#x27;s3SecrestKey&#x27; : &#x27;xxx&#x27;,
        &#x27;bucketName&#x27; : &#x27;polar&#x27;,
        &#x27;folder&#x27; : s3Folder,
    }
    coverGeometry = importToBucket(s3config, resultsFolder, True)
    
    collectionID_300m = &#x27;d34c470c-52a8-49db-9f9b-0956f10734d9&#x27;
    collectionID_500m = &#x27;6a3a4f71-84ff-4421-95a7-6ba969b5cf88&#x27;
    
    collectionId = collectionID_300m if resolution == 300 else collectionID_500m
    
    shConfig = {
        &#x27;byoc_service_base_url&#x27; : &#x27;https://creodias.sentinel-hub.com/api/v1/byoc&#x27;,
        &#x27;client_id&#x27; : &#x27;xxx&#x27;,
        &#x27;client_secret&#x27; : &#x27;xxx&#x27;,
        &#x27;collection_id&#x27; : collectionId,
        &#x27;folder&#x27; : s3Folder,
        &#x27;sensingTime&#x27; : sensingTime,
        &#x27;coverGeometry&#x27; : coverGeometry
    }    
    importToBYOC(shConfig)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="c0EnBBF_3nO8avoy-T2ar" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="IA92mRsso1" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Various utilities
import os
import json
from shapely import geometry, wkt
import datetime as dt
import numpy as np
import geopandas as gpd
import glob
import shutil
import logging
import concurrent.futures
import time

from sentinelhub import SentinelHubDownloadClient, SentinelHubBatch, SentinelHubRequest, Geometry, CRS, DataCollection, MimeType, SHConfig, BBox, bbox_to_dimensions
from shapely.geometry import Polygon
import tarfile

# create logs folder
if not os.path.exists(&quot;logs&quot;):
    os.makedirs(&quot;logs&quot;)

# right now we only log to consol
logging.basicConfig(
    format=&#x27;%(asctime)s [%(levelname)s] %(name)s - %(message)s&#x27;,
    level=logging.INFO,
    datefmt=&#x27;%Y-%m-%d %H:%M:%S&#x27;,
    handlers=[
        logging.FileHandler(f&#x27;logs/sice_sh_{time.strftime(&quot;%Y_%m_%d&quot;,time.localtime())}.log&#x27;),
        logging.StreamHandler()
    ])</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="Z90H7sK9qIbMyfGw64aue" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="SzPHLZwPrD" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">#External variables
# Set the date of calculation
date = &quot;2021-07-09&quot;

# resolution (m) 
resolution = 1200  # minimum resolution of data is 300m

#area of interest
aoi = &#x27;POLYGON((-53.6565 82.4951, -59.9608 82.1309, -67.7892 80.5602, -67.9606 80.0218, -67.6072 79.3014, -72.7375 78.5894, -73.5413 78.1636, -72.9428 77.3837, -69.0700 76.0128, -66.6509 75.7624, -60.3956 75.8231, -58.4311 74.8854, -55.1967 69.6980, -53.8565 68.8368, -54.2986 67.0754, -53.5562 65.6109, -52.3863 64.7989, -52.3228 64.0074, -50.2076 62.1010, -48.6300 60.7381, -45.0522 59.7674, -43.2890 59.6436, -42.4957 60.3093, -41.8486 61.5655, -41.6969 62.6486, -40.1106 63.5452, -39.9111 64.7944, -38.0777 65.4068, -36.9899 65.1987, -31.2165 67.7166, -25.8502 68.6303, -21.6517 70.0839, -20.9932 70.7880, -21.2829 72.9254, -16.9050 74.9601, -17.1213 79.6158, -10.2883 81.4244, -14.0398 81.9745, -17.8112 82.0131, -28.5252 83.7013, -40.1075 83.6651, -53.6565 82.4951))&#x27;
aoi = &quot;POLYGON ((-14.675905 65.792421, -14.675905 66.238873, -13.423464 66.238873, -13.423464 65.792421, -14.675905 65.792421))&quot;
#sub-area
#aoi = &#x27;POLYGON ((-56.045995 66.271911, -49.369389 66.271911, -49.369389 71.949832, -56.045995 71.949832, -56.045995 66.271911))&#x27;

#Island
#aoi = &#x27;POLYGON ((-24.634498 66.588207, -13.38895 66.588207, -13.38895 63.292939, -24.634498 63.292939, -24.634498 66.588207))&#x27;

#target projection of the final results
projection = &#x27;4326&#x27; #default

#projection = &#x27;3413&#x27;  #polar
 

# log processing parameters - don&#x27;t log any S3 information
logging.info(f&#x27;Date: {date}&#x27;)
logging.info(f&#x27;AOI: {aoi}&#x27;)
logging.info(f&#x27;Projection: {projection}&#x27;)

</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="_BE4WAYk2-9VdG-uV5-zy" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:11 [INFO] root - Date: 2021-07-09
2023-03-07 14:49:11 [INFO] root - AOI: POLYGON ((-14.675905 65.792421, -14.675905 66.238873, -13.423464 66.238873, -13.423464 65.792421, -14.675905 65.792421))
2023-03-07 14:49:11 [INFO] root - Projection: 4326
</span></code></pre></div></div></div></div><div id="FXJMQP7exX" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">#verify input parameters

if not date:
    raise Exception(&#x27;variable date has to be set&#x27;) 

if not aoi:
    raise Exception(&#x27;aoi has to be set&#x27;)     

if not resolution:
    raise Exception(&#x27;resolution has to be set&#x27;)     

if resolution &lt; 300 or resolution &gt; 1200: 
    raise Exception(&#x27;value of resolution has to be between 200 m and 1200 m&#x27;)

#transform period into single day    
if &#x27;/&#x27; in date:
    date = date[0:date.find(&#x27;/&#x27;)]    </code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="PaBjqVU-p6pUEBzKPT7-q" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="Hs6fNHKtvi" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">#system settings

#base folder where the code is located
USR_PATH = os.path.abspath(&#x27;.&#x27;)
EVAL_SCRIPT_PATH = os.path.join(USR_PATH, &#x27;data_fusion_olci_dem.js&#x27;) 

#delete download folder after processing - will save space but will download all the data for each requwst (otherwise the cached tile data will be used)
DELETE_DOWNLOAD_FOLDER = True

#OUTPUT_DIR = os.path.join(USR_PATH, &quot;output&quot;) #local folder
OUTPUT_DIR = &quot;/home/jovyan/result-data&quot; # will be copied to the local folder of the user requesting the data

logging.info(&quot;System configuration ok.&quot;)    
</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="WrVijfym8QgQjh23R4_S8" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:11 [INFO] root - System configuration ok.
</span></code></pre></div></div></div></div><div id="PhaPPrF8hO" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># initial ENV configuration
SH_CLIENT_ID = %env SH_CLIENT_ID
SH_CLIENT_SECRET = %env SH_CLIENT_SECRET

sh_config = SHConfig()
sh_config.sh_base_url = &quot;https://services.sentinel-hub.com&quot;
sh_config.download_timeout_seconds=300
sh_config.download_sleep_time=20

sh_config.sh_client_id = SH_CLIENT_ID
sh_config.sh_client_secret = SH_CLIENT_SECRET

sh_config.save()

# Evalscript
evalscript = &quot;&quot;&quot;
//VERSION=3
function setup() {
  return {
    input: [
      {
        datasource: &quot;OLCI&quot;,
        bands: [&quot;B01&quot;, &quot;B02&quot;, &quot;B03&quot;, &quot;B04&quot;, &quot;B05&quot;, &quot;B06&quot;, &quot;B07&quot;, &quot;B08&quot;, &quot;B09&quot;, &quot;B10&quot;, &quot;B11&quot;, &quot;B12&quot;, &quot;B13&quot;, &quot;B14&quot;, &quot;B15&quot;, &quot;B16&quot;, &quot;B17&quot;, &quot;B18&quot;, &quot;B19&quot;, &quot;B20&quot;, &quot;B21&quot;, &quot;SZA&quot;, &quot;VZA&quot;, &quot;SAA&quot;, &quot;VAA&quot;, &quot;TOTAL_COLUMN_OZONE&quot;],
      },
      {
        datasource: &quot;COP_30&quot;,
        bands: [&quot;DEM&quot;]
      }
    ],
    output: [
      {
        id: &quot;r_TOA_01&quot;,
        bands: 1,
        sampleType: &quot;FLOAT32&quot;,
      },
      {
        id: &quot;r_TOA_06&quot;,
        bands: 1,
        sampleType: &quot;FLOAT32&quot;,
      },
      {
        id: &quot;r_TOA_17&quot;,
        bands: 1,
        sampleType: &quot;FLOAT32&quot;,
      },
      {
        id: &quot;r_TOA_21&quot;,
        bands: 1,
        sampleType: &quot;FLOAT32&quot;,
      },
      {
        id: &quot;snow_grain_diameter&quot;,
        bands: 1,
        sampleType: &quot;FLOAT32&quot;,
      },
      {
        id: &quot;snow_specific_surface_area&quot;,
        bands: 1,
        sampleType: &quot;FLOAT32&quot;,
      },
      {
        id: &quot;diagnostic_retrieval&quot;,
        bands: 1,
        sampleType: &quot;UINT8&quot;,
      },
      {
        id: &quot;albedo_bb_planar_sw&quot;,
        bands: 1,
        sampleType: &quot;FLOAT32&quot;,
      },
      {
        id: &quot;albedo_bb_spherical_sw&quot;,
        bands: 1,
        sampleType: &quot;FLOAT32&quot;,
      }

    ],
    mosaicking: &quot;SIMPLE&quot;,
  };
}

//function updateOutput(outputs, collections) {
//  Object.values(outputs).forEach((output) =&gt; {
//    output.bands = collections.scenes.length;
//  });
//}

// Set constants as global variables which can be used in all functions
var wls = {
  &quot;B01&quot;: 0.4000E+00,
  &quot;B02&quot;: 0.4125E+00,
  &quot;B03&quot;: 0.4425E+00,
  &quot;B04&quot;: 0.4900E+00,
  &quot;B05&quot;: 0.5100E+00,
  &quot;B06&quot;: 0.5600E+00,
  &quot;B07&quot;: 0.6200E+00,
  &quot;B08&quot;: 0.6650E+00,
  &quot;B09&quot;: 0.6737E+00,
  &quot;B10&quot;: 0.6812E+00,
  &quot;B11&quot;: 0.7088E+00,
  &quot;B12&quot;: 0.7538E+00,
  &quot;B13&quot;: 0.7613E+00,
  &quot;B14&quot;: 0.7644E+00,
  &quot;B15&quot;: 0.7675E+00,
  &quot;B16&quot;: 0.7788E+00,
  &quot;B17&quot;: 0.8650E+00,
  &quot;B18&quot;: 0.8850E+00,
  &quot;B19&quot;: 0.9000E+00,
  &quot;B20&quot;: 0.9400E+00,
  &quot;B21&quot;: 0.1020E+01
};

var bai = {
  &quot;B01&quot;: 2.365E-11,
  &quot;B02&quot;: 2.7E-11,
  &quot;B03&quot;: 7.0E-11,
  &quot;B04&quot;: 4.17E-10,
  &quot;B05&quot;: 8.04E-10,
  &quot;B06&quot;: 2.84E-09,
  &quot;B07&quot;: 8.58E-09,
  &quot;B08&quot;: 1.78E-08,
  &quot;B09&quot;: 1.95E-08,
  &quot;B10&quot;: 2.1E-08,
  &quot;B11&quot;: 3.3E-08,
  &quot;B12&quot;: 6.23E-08,
  &quot;B13&quot;: 7.1E-08,
  &quot;B14&quot;: 7.68E-08,
  &quot;B15&quot;: 8.13E-08,
  &quot;B16&quot;: 9.88E-08,
  &quot;B17&quot;: 2.4E-07,
  &quot;B18&quot;: 3.64E-07,
  &quot;B19&quot;: 4.2E-07,
  &quot;B20&quot;: 5.53e-07,
  &quot;B21&quot;: 2.25E-06
}

let emptyBandObject = {
  &quot;B01&quot;: {},
  &quot;B02&quot;: {},
  &quot;B03&quot;: {},
  &quot;B04&quot;: {},
  &quot;B05&quot;: {},
  &quot;B06&quot;: {},
  &quot;B07&quot;: {},
  &quot;B08&quot;: {},
  &quot;B09&quot;: {},
  &quot;B10&quot;: {},
  &quot;B11&quot;: {},
  &quot;B12&quot;: {},
  &quot;B13&quot;: {},
  &quot;B14&quot;: {},
  &quot;B15&quot;: {},
  &quot;B16&quot;: {},
  &quot;B17&quot;: {},
  &quot;B18&quot;: {},
  &quot;B19&quot;: {},
  &quot;B20&quot;: {},
  &quot;B21&quot;: {}
}

const allBands = Object.keys(bai);

// solar spectrum constants
const f0 = 32.38;
const f1 = -160140.33;
const f2 = 7959.53;
const bet = 1. / (85.34 * 1.e-3);
const gam = 1. / (401.79 * 1.e-3);

var coef1, coef2 = analyt_func(0.3, 0.7);
var coef3, coef4 = analyt_func(0.7, 0.865);

function evaluatePixel(samples) {
  const n_acquisitions = samples.OLCI.length;
  const olciSamples = samples.OLCI;
  const demSamples = samples.COP_30;
  let r_TOA_01_valid = [];
  let r_TOA_06_valid = [];
  let r_TOA_17_valid = [];
  let r_TOA_21_valid = [];
  let snow_grain_diameter = [];
  let snow_specific_surface_area = [];

  // new products
  let diagnostic_retrieval = [];
  let albedo_bb_planar_sw = [];
  let albedo_bb_spherical_sw = [];



  // Loop through acquisition dates. No need to use this for single acquisition processing.
  for (aq = 0; aq &lt; n_acquisitions; aq++) {
    // Correct TOA reflectance for ozone absorption
    sample_cor_o3 = ozone_correction(olciSamples[aq]);

    //Transfer of OLCI relative azimuthal angle to the definition used in radiative transfer code
    angles = view_geometry(olciSamples[aq]);

    //Filtering pixels unsuitable for retrieval
    [snow, sample_fltr] = prepare_processing(sample_cor_o3, demSamples[0]);

    //Compute snow properties
    [sample_valid, angles_valid, snow] = snow_properties(sample_fltr, angles, snow);

    //Compute aerosol
    aerosol = aerosol_properties(demSamples[0].DEM, angles_valid.cos_sa);

    //Compute atmosphere
    atmosphere = prepare_coef(aerosol, angles);

    //Compute theoretical reflectance of snow from albedo
    snow = clean_snow_albedo(sample_valid, angles, aerosol, atmosphere, snow);

    //throw new Error(JSON.stringify(snow))

    snow = polluted_snow_albedo(sample_valid, angles, aerosol, atmosphere, snow);

    snow = compute_plane_albedo(snow, angles);

    r_TOA_01_valid.push(sample_valid.B01);
    r_TOA_06_valid.push(sample_valid.B06);
    r_TOA_17_valid.push(sample_valid.B17);
    r_TOA_21_valid.push(sample_valid.B21);
    snow_grain_diameter.push(snow.diameter);
    snow_specific_surface_area.push(snow.area);
    diagnostic_retrieval.push(snow.isnow);
    albedo_bb_planar_sw.push(snow.rp3);
    albedo_bb_spherical_sw.push(snow.rs3);

    // Development use. Allow you to check the output before the script is finished.
    //throw new Error(JSON.stringify(snow))
  }
  return {
    r_TOA_01: r_TOA_01_valid,
    r_TOA_06: r_TOA_06_valid,
    r_TOA_17: r_TOA_17_valid,
    r_TOA_21: r_TOA_21_valid,
    snow_grain_diameter: snow_grain_diameter,
    snow_specific_surface_area: snow_specific_surface_area,
    diagnostic_retrieval: diagnostic_retrieval,
    albedo_bb_planar_sw: albedo_bb_planar_sw,
    albedo_bb_spherical_sw: albedo_bb_spherical_sw
  };
}

function deg2rad(deg) {
  const pi = Math.PI;
  return deg * (pi / 180);
}

function ozone_correction(sample) {
  const tozone_dict = {
    &quot;B01&quot;: 1.378170469E-004,
    &quot;B02&quot;: 3.048780958E-004,
    &quot;B03&quot;: 1.645714060E-003,
    &quot;B04&quot;: 8.935947110E-003,
    &quot;B05&quot;: 1.750535146E-002,
    &quot;B06&quot;: 4.347104369E-002,
    &quot;B07&quot;: 4.487130794E-002,
    &quot;B08&quot;: 2.101591797E-002,
    &quot;B09&quot;: 1.716230955E-002,
    &quot;B10&quot;: 1.466298300E-002,
    &quot;B11&quot;: 7.983028470E-003,
    &quot;B12&quot;: 3.879744653E-003,
    &quot;B13&quot;: 2.923775641E-003,
    &quot;B14&quot;: 2.792211429E-003,
    &quot;B15&quot;: 2.729651478E-003,
    &quot;B16&quot;: 3.255969698E-003,
    &quot;B17&quot;: 8.956858078E-004,
    &quot;B18&quot;: 5.188799343E-004,
    &quot;B19&quot;: 6.715773241E-004,
    &quot;B20&quot;: 3.127781417E-004,
    &quot;B21&quot;: 1.408798425E-005
  };
  let toa_cor_o3 = {};
  // Loop through OLCI bands
  allBands.forEach(band =&gt; {
    todadu = sample.TOTAL_COLUMN_OZONE * 46696.24;
    inv_cos_za = 1 / Math.cos(deg2rad(sample.SZA)) + 1 / Math.cos(deg2rad(sample.VZA));
    toa_cor_o3[band] = sample[band] * 1 * Math.exp(inv_cos_za * tozone_dict[band] * todadu / 404.59);
  });

  toa_cor_o3.SZA = sample.SZA;
  toa_cor_o3.VZA = sample.VZA;
  toa_cor_o3.SAA = sample.SAA;
  toa_cor_o3.VAA = sample.VAA;
  return toa_cor_o3;
}

function view_geometry(sample) {
  const raa = 180 - (sample.VAA - sample.SAA);
  const sin_sza = Math.sin(deg2rad(sample.SZA));
  const sin_vza = Math.sin(deg2rad(sample.VZA));
  const cos_sza = Math.cos(deg2rad(sample.SZA));
  const cos_vza = Math.cos(deg2rad(sample.VZA));
  const ak1 = 3 * (1 + 2 * cos_sza) / 7;
  const ak2 = 3 * (1 + 2 * cos_vza) / 7;
  const cos_raa = Math.cos(deg2rad(raa));
  const inv_cos_za = 1 / cos_sza + 1 / cos_vza;
  const cos_sa = -cos_sza * cos_vza + sin_sza * sin_vza * cos_raa;
  return {
    raa: raa,
    cos_sza: cos_sza,
    cos_vza: cos_vza,
    ak1: ak1,
    ak2: ak2,
    inv_cos_za: inv_cos_za,
    cos_sa: cos_sa
  };
}

function prepare_processing(sample_cor, sample_dem) {
  let snow = {};
  let sample_fltr = {};

  // Assign diagnostic code
  snow.isnow = sample_cor.B21 &lt; 0.1 ? 102 : NaN;
  snow.isnow = sample_cor.SZA &gt; 75 ? 100 : snow.isnow;
  const mask = isNaN(snow.isnow);

  // Loop through OLCI bands
  allBands.forEach(band =&gt; {
    sample_fltr[band] = (mask == true) ? sample_cor[band] : NaN;
  });

  // Add elevation info to the object
  sample_fltr.elevation = (mask == true) ? sample_dem.DEM : NaN;
  return [
    snow,
    sample_fltr
  ];
}

function snow_properties(sample_fltr, angles, snow) {
  const akap2 = 2.25e-6;
  const alpha2 = 4 * Math.PI * akap2 / 1.020;
  const eps = 1.549559365010611;
  const rr1 = sample_fltr.B17;
  const rr2 = sample_fltr.B21;
  const ak1 = angles.ak1;
  const ak2 = angles.ak2;
  const r0 = Math.pow(rr1, eps) * Math.pow(rr2, (1 - eps));
  const bal = Math.pow((Math.log(rr2 / r0) / (ak1 * ak2 / r0)), 2) / alpha2;
  const al = bal / 1000;
  const D = al / (9.2 * 16 / 9);
  const area = 6 / D / 0.917;

  //Filtering small D
  const diameter_thresh = 0.01;
  const valid = D &gt;= diameter_thresh;
  snow.isnow = (!valid &amp;&amp; isNaN(snow.isnow)) ? 104 : snow.isnow;

  //Loop through toa bands
  let sample_valid = {};

  allBands.forEach(band =&gt; {
    sample_valid[band] = valid ? sample_fltr[band] : NaN;
  });

  //Assign valid snow properties
  snow.diameter = valid ? D : NaN;
  snow.area = valid ? area : NaN;
  snow.al = valid ? al : NaN;
  snow.r0 = valid ? r0 : NaN;
  snow.bal = valid ? bal : NaN;

  //Loop through angles attributes
  let angles_valid = {};
  const angles_attrs = Object.keys(angles);
  for (attr = 0; attr &lt; angles_attrs.length; attr++) {
    angles_valid[angles_attrs[attr]] = valid ? angles[angles_attrs[attr]] : NaN;
  }
  return [
    sample_valid,
    angles_valid,
    snow
  ];
}

function aerosol_properties(height, cos_sa, aot = 0.1) {
  // Set an aerosol object to store the result. 
  let aerosol = {
    &quot;tau&quot;: {},
    &quot;p&quot;: {},
    &quot;g&quot;: {},
    &quot;gaer&quot;: {},
    &quot;taumol&quot;: {},
    &quot;tauaer&quot;: {}
  };

  // Loop through OLCI bands
  allBands.forEach(band =&gt; {
    tauaer = aot * Math.pow((wls[band] / 0.5), -1.3);
    g0 = 0.5263;
    g1 = 0.4627;
    wave0 = 0.4685;
    gaer = g0 + g1 * Math.exp(-wls[band] / wave0);
    pr = 0.75 * (1 + Math.pow(cos_sa, 2));
    taumol = Math.pow(wls[band], -4.05) * Math.min(1, Math.exp(-height / 7400)) * 0.00877;
    tau = tauaer + taumol;
    g = tauaer * gaer / tau;
    pa = (1 - Math.pow(g, 2)) / Math.pow((1 - 2 * g * cos_sa + Math.pow(g, 2)), 1.5);
    p = (taumol * pr + tauaer * pa) / tau;

    // Assign results to objects. Values can be called via, e.g., aerosol.tau.B01
    Object.assign(aerosol.tau, { [band]: tau })
    Object.assign(aerosol.p, { [band]: p })
    Object.assign(aerosol.g, { [band]: g })
    Object.assign(aerosol.gaer, { [band]: gaer })
    Object.assign(aerosol.taumol, { [band]: taumol })
    Object.assign(aerosol.tauaer, { [band]: tauaer })
  });
  return aerosol;
}

// Solar flux
function sol(x) {
  // SOLAR SPECTRUM at GROUND level
  // Inputs:
  // x - wave length in micrometer
  // Outputs: 
  // sol - solar spectrum in W m-2 micrometer-1 (?)
  sol1a = f0 * x;
  sol1b = - f1 * Math.exp(-bet * x) / bet;
  sol1c = - f2 * Math.exp(-gam * x) / gam;
  return sol1a + sol1b + sol1c;
}

function analyt_func(z1, z2) {
  // see BBA_calc_pol
  // compatible with array
  var gam2 = Math.exp(gam, 2);
  var gam3 = Math.exp(gam, 3);

  var z12 = Math.exp(z1, 2);
  var z13 = Math.exp(z1, 3);

  var z22 = Math.exp(z2, 2);
  var z23 = Math.exp(z2, 3);

  var bet2 = Math.exp(bet, 2);
  var bet3 = Math.exp(bet, 3);

  var ak1 = (z22 - z12) / 2.0;
  var ak2 = (z2 / bet + 1.0 / bet2) * Math.exp(-bet * z2) - (z1 / bet + 1.0 / bet2) * Math.exp(-bet * z1);
  var ak3 = (z2 / gam + 1.0 / gam2) * Math.exp(-gam * z2) - (z1 / gam + 1.0 / gam2) * Math.exp(-gam * z1);
  var am_minus = (z12 / bet + 2.0 * z1 / bet2 + 2.0 / bet3) * Math.exp(-bet * z1);

  var am1 = (z23 - z13) / 3.0;
  var am2 = (z22 / bet + 2.0 * z2 / bet2 + 2.0 / bet3) * Math.exp(-bet * z2) - am_minus
  var am3 = (z22 / gam + 2.0 * z2 / gam2 + 2.0 / gam3) * Math.exp(-gam * z2) - am_minus;

  return (f0 * ak1 - f1 * ak2 - f2 * ak3), (f0 * am1 - f1 * am2 - f2 * am3);
}

function prepare_coef(aerosol, angles) {
  // Set an atmosphere object 
  let atmosphere = {
    &quot;t1&quot;: {},
    &quot;t2&quot;: {},
    &quot;ratm&quot;: {},
    &quot;r&quot;: {}
  };

  // Loop through OLCI bands
  allBands.forEach(band =&gt; {
    tau = aerosol.tau[band];
    g = aerosol.g[band];
    p = aerosol.p[band];
    cos_sza = angles.cos_sza;
    cos_vza = angles.cos_vza;
    inv_cos_za = angles.inv_cos_za;

    one_g_tau = (1 - g) * tau;

    b1 = 1 + 1.5 * cos_sza + (1 - 1.5 * cos_sza) * Math.exp(-tau / cos_sza);
    b2 = 1 + 1.5 * cos_vza + (1 - 1.5 * cos_vza) * Math.exp(-tau / cos_vza);

    sumcos = cos_sza + cos_vza;

    astra = (1 - Math.exp(-tau * inv_cos_za)) / sumcos / 4;
    oskar = 4 + 3 * one_g_tau;

    rms = 1 - b1 * b2 / oskar + (3 * (1 + g) * (cos_sza * cos_vza) - 2 * sumcos) * astra;

    r = p * astra + rms;

    wa1 = 1.10363;
    wa2 = -6.70122;
    wx0 = 2.19777;
    wdx = 0.51656;
    bex = Math.exp((g - wx0) / wdx);

    arg = -0.5 * one_g_tau / ((wa1 - wa2) / (1 + bex) + wa2);

    t1 = Math.exp(arg / cos_sza);
    t2 = Math.exp(arg / cos_vza);

    a_s = [.18016, -0.18229, 0.15535, -0.14223];
    bs = [.58331, -0.50662, -0.09012, 0.0207];
    cs = [0.21475, -0.1, 0.13639, -0.21948];
    als = [0.16775, -0.06969, 0.08093, -0.08903];
    bets = [1.09188, 0.08994, 0.49647, -0.75218];

    a_cst = a_s[0] + a_s[1] * g;
    b_cst = bs[0] + bs[1] * g;
    c_cst = cs[0] + cs[1] * g;
    al_cst = als[0] + als[1] * g;
    bet_cst = bets[0] + bets[1] * g;

    for (num = 2; num &lt; 4; num++) {
      if (num == 2) {
        gg = Math.pow(g, 2);
      } else {
        gg *= g;
      }
      a_cst += a_s[num] * gg
      b_cst += bs[num] * gg
      c_cst += cs[num] * gg
      al_cst += als[num] * gg
      bet_cst += bets[num] * gg
    }
    ratm = tau * (a_cst * Math.exp(-tau / al_cst) + b_cst * Math.exp(-tau / bet_cst) + c_cst)

    // Assign the results to the objects
    Object.assign(atmosphere.t1, { [band]: t1 });
    Object.assign(atmosphere.t2, { [band]: t2 });
    Object.assign(atmosphere.ratm, { [band]: ratm });
    Object.assign(atmosphere.r, { [band]: r });
  });

  return atmosphere;
}

function alb2rtoa(a, t1, t2, r0, ak1, ak2, ratm, r) {
  const surf = t1 * t2 * r0 * Math.pow(a, (ak1 * ak2 / r0)) / (1 - a * ratm);
  const rs = r + surf;
  return rs;
}

function clean_snow_albedo(sample_valid, angles, aerosol, atmosphere, snow) {
  snow.rs_1 = alb2rtoa(1, atmosphere.t1.B01, atmosphere.t2.B01, 1, 1, 1, atmosphere.ratm.B01, atmosphere.r.B01);
  snow.ind_clean = sample_valid.B01 &gt;= snow.rs_1;
  snow.isnow = (snow.ind_clean) ? 0 : snow.isnow;
  snow.ind_pol = sample_valid.B01 &lt; snow.rs_1;

  var alb_sph = Object.assign({}, emptyBandObject);
  allBands.forEach(band =&gt; {
    alb_sph[band] = Math.min(Math.exp(-Math.sqrt(1000 * 4 * Math.PI * (bai[band] / wls[band] * snow.al))), 1);
  });

  // Assign the results to the objects
  snow.alb_sph = alb_sph;
  return snow;
}

function polluted_snow_albedo(sample_valid, angles, aerosol, atmosphere, snow) {
  //throw new Error(JSON.stringify(sample_valid));

  if (snow.ind_pol) {
    snow.isnow = (snow.ind_pol) ? 1 : snow.isnow;
    ind_very_dark = (sample_valid.B21 &lt; 0.4 &amp;&amp; snow.ind_pol);
    snow.isnow = (ind_very_dark) ? 6 : snow.isnow;
    snow.r0 = (!ind_very_dark) ? snow.isnow : compute_rclean(angles.cos_sza, angles.cos_vza, angles.cos_sa, angles.raa);
    //snow.alb_sph = (snow.ind_pol) ? 1 : snow.alb_sph; Guess it applies to all bands
    Object.keys(snow.alb_sph).forEach(band =&gt; {
      snow.alb_sph[band] = (snow.ind_pol) ? 1 : snow.alb_sph[band]
    })

    const bands_to_loop_over = Object.keys(sample_valid);
    bands_to_loop_over.splice(18, 2);

    //throw new Error(JSON.stringify(bands_to_loop_over));

    for (i = 0; i &lt; bands_to_loop_over.length; i++) {
      var band = bands_to_loop_over[i];
      snow.alb_sph[band] = (snow.ind_pol) ? solver_wrapper(sample_valid[band], atmosphere.t1[band], atmosphere.t2[band], snow.r0, angles.ak1, angles.ak2, atmosphere.ratm[band], atmosphere.r[band]) : snow.alb_sph[band];
      snow.isnow = snow.alb_sph[band] == -999 ? -(i + 1) : snow.isnow;
    }

    // Guess it applies to all bands
    Object.keys(snow.alb_sph).forEach(band =&gt; {
      snow.alb_sph[band] = snow.isnow ? snow.alb_sph[band] : NaN;
    })

    let ind_clear_pol = (snow.alb_sph.B01 &gt; 0.98 | snow.alb_sph.B02 &gt; 0.98) &amp; snow.ind_pol;
    snow.isnow = ind_clear_pol ? 7 : snow.isnow;

    // Guess it applies to all bands
    if (!ind_clear_pol) {
      allBands.forEach(band =&gt; {
        snow.alb_sph[band] = Math.exp(-Math.sqrt(4 * 1000 * Math.PI * snow.al * (bai[band] / wls[band])));
      });
    }

    snow.ind_pol = snow.ind_pol &amp; (snow.isnow != 7);

    // reprocessing of albedo to remove gaseous absorption using linear polynomial approximation in the range 753-778nm.
    // Meaning: alb_sph[12],alb_sph[13] and alb_sph[14] are replaced by a linear  interpolation between alb_sph[11] and alb_sph[15]
    if (ind_clear_pol) {
      afirn = snow.alb_sph[&#x27;B15&#x27;] - snow.alb_sph[&#x27;B11&#x27;] / (wls[&#x27;B15&#x27;] - wls[&#x27;B11&#x27;]);
      bfirn = snow.alb_sph[&#x27;B15&#x27;] - afirn * wls[&#x27;B15&#x27;];

      // indeces of bands start with 0!
      allBands.concat().splice(11, 3).forEach(band =&gt; {
        snow.alb_sph[band] = bfirn + afirn * wls[band];
      });
    }

    // pixels that are clean enough in channels 18 19 20 and 21 are not affected by pollution, the analytical equation can then be used
    ind_ok = (sample_valid.B20 &gt; 0.35) &amp; snow.ind_pol;
    if (ind_ok) {
      allBands.concat().splice(17, 4).forEach(band =&gt; {
        snow.alb_sph[band] = Math.exp(-Math.sqrt(4. * 1000. * Math.PI * snow.al * (bai[band] / wls[band])));
      });
    }

    //to avoid the influence of gaseous absorption (water vapor) we linearly interpolate in the range 885-1020nm for bare ice cases only (low toa[20])
    //Meaning: alb_sph[18] and alb_sph[19] are replaced by a linear interpolation between alb_sph[17] and alb_sph[20]
    if (ind_ok) {
      bcoef = (snow.alb_sph[&#x27;B20&#x27;] - snow.alb_sph[&#x27;B17&#x27;]) / (wls[&#x27;B20&#x27;] - wls[&#x27;17&#x27;])
      acoef = snow.alb_sph[&#x27;B20&#x27;] - bcoef * wls[&#x27;B20&#x27;]
      allBands.concat().splice(17, 2).forEach(band =&gt; {
        snow.alb_sph[band] = acoef + bcoef * wls[band];
      });
    }
  }
  return snow;
}

function compute_plane_albedo(snow, angles) {
  var rp = Object.assign({}, emptyBandObject);
  var refl = Object.assign({}, emptyBandObject);

  snow.rp = rp;
  snow.refl = refl;

  allBands.forEach(band =&gt; {
    snow.rp[band] = Math.pow(snow.alb_sph[band], angles.ak1);
    snow.refl[band] = snow.r0[band] * Math.pow(snow.alb_sph[band], angles.ak1 * angles.ak2 / snow.r0);
  });

  ind_all_clean = snow.ind_clean || (snow.isnow == 7);


  if (ind_all_clean) {
    snow.rp3 = plane_albedo_sw_approx(snow.diameter, angles.cos_sza);
    snow.rs3 = spher_albedo_sw_approx(snow.diameter);
  }

  // solar flux calculation
  // sol1      visible(0.3 - 0.7micron)
  // somehow, a different sol1 needs to be used for clean snow and polluted snow
  var sol1_pol = sol(0.7) - sol(0.3);
  // sol2      near - infrared(0.7 - 2.4micron)
  // same for clean and polluted
  var sol2 = sol(2.4) - sol(0.7);

  // sol3      shortwave(0.3 - 2.4 micron)
  // sol3 is also different for clean snow and polluted snow
  var sol3_pol = sol1_pol + sol2;

  // asol specific band
  var asol = sol(0.865) - sol(0.7);

  if (snow.ind_pol) {
    snow.rp3 = BBA_calc_pol(snow.rp, asol, sol1_pol, sol3_pol);
    snow.rs3 = BBA_calc_pol(snow.alb_sph, asol, sol1_pol, sol3_pol);
  }

  return snow;
}

function BBA_calc_pol(alb, asol, sol1_pol, sol3_pol) {
  // polluted snow
  // NEW CODE FOR BBA OF BARE ICE
  // alb is either the planar or spherical albedo

  // ANAlYTICal EQUATION FOR THE NOMINATOR
  // integration over 3 segments

  // segment 1
  // QUADRATIC POLYNOMIal for the range 400 - 709nm
  // input wavelength
  //    alam2 = w[0]
  //    alam3 = w[5]
  //    alam5 = w[10]
  //    alam6 = w[11]
  //    alam7 = w[16]
  //    alam8 = w[20]

  const alam2 = 0.4;
  const alam3 = 0.56;
  const alam5 = 0.709;
  const alam6 = 0.753;
  const alam7 = 0.865;
  const alam8 = 1.02;

  // input reflectances
  var r2 = alb[&#x27;B01&#x27;];
  var r3 = alb[&#x27;B05&#x27;];
  var r5 = alb[&#x27;B10&#x27;];
  var r6 = alb[&#x27;B011&#x27;];
  var r7 = alb[&#x27;B16&#x27;];
  var r8 = alb[&#x27;B20&#x27;];

  // declared outside
  //var coef1, coef2 = analyt_func(0.3, 0.7);
  //var coef3, coef4 = analyt_func(0.7, 0.865);

  var a1, b1, c1 = quad_func(alam2, alam3, alam5, r2, r3, r5)
  var aj1 = a1 * sol1_pol + b1 * coef1 + c1 * coef2;

  // segment 2.1
  // QUADRATIC POLYNOMIal for the range 709 - 865nm
  var a2, b2, c2 = quad_func(alam5, alam6, alam7, r5, r6, r7)
  var aj2 = a2 * asol + b2 * coef3 + c2 * coef4;    // segment 2.2

  // exponential approximation for the range 865 - 2400 nm
  const z1 = 0.865;
  const z2 = 2.4;
  var rati = r7 / r8;
  var alasta = (alam8 - alam7) / Math.log(rati);
  var an = 1. / alasta;
  var p = r7 * Math.exp(alam7 / alasta);

  var aj31 = (1. / an) * (Math.exp(-an * z2) - Math.exp(-an * z1));
  var aj32 = (1. / (bet + an)) * (Math.exp(-(bet + an) * z2) - Math.exp(-(an + bet) * z1));
  var aj33 = (1. / (gam + an)) * (Math.exp(-(gam + an) * z2) - Math.exp(-(an + gam) * z1));
  var aj3 = (-f0 * aj31 - f1 * aj32 - f2 * aj33) * p;

  return (aj1 + aj2 + aj3) / sol3_pol;
}

function quad_func(x0, x1, x2, y0, y1, y2) {
  // quadratic function used for the polluted snow BBA calculation
  // see BBA_calc_pol
  // compatible with arrays
  var d1 = (x0 - x1) * (x0 - x2);
  var d2 = (x1 - x0) * (x1 - x2);
  var d3 = (x2 - x0) * (x2 - x1);

  var a1 = x1 * x2 * y0 / d1 + x0 * x2 * y1 / d2 + x0 * x1 * y2 / d3;
  var b1 = -(x1 + x2) * y0 / d1 - (x0 + x2) * y1 / d2 - (x0 + x1) * y2 / d3;
  var c1 = y0 / d1 + y1 / d2 + y2 / d3;
  var x = x1;
  return a1, b1, c1;
}

function spher_albedo_sw_approx(D) {
  return 0.6420 + 0.1044 * Math.exp(-1000 * D / 158.62) + 0.1773 * Math.exp(-1000 * D / 2448.18);
}

function plane_albedo_sw_approx(D, cos_sza) {
  var cos_sza2 = Math.exp(cos_sza, 2);
  var anka = 0.7389 - 0.1783 * cos_sza + 0.0484 * cos_sza2;
  var banka = 0.0853 + 0.0414 * cos_sza - 0.0127 * cos_sza2
  var canka = 0.1384 + 0.0762 * cos_sza - 0.0268 * cos_sza2;
  var diam1 = 187.89 - 69.2636 * cos_sza + 40.4821 * cos_sza2;
  var diam2 = 2687.25 - 405.09 * cos_sza + 94.5 * cos_sza2;
  return anka + banka * Math.exp(-1000 * D / diam1) + canka * Math.exp(-1000 * D / diam2)
}

function compute_rclean(cos_sza, cos_vza, cos_sa, raa) {
  const am11 = Math.sqrt(1 - Math.pow(cos_sza, 2));
  const am12 = Math.sqrt(1 - Math.pow(cos_vza, 2));
  const theta = Math.acos(-cos_sza * cos_vza + am11 * am12 * Math.cos(raa * 3.14159 / 180)) * 180 / Math.PI;
  const pz = 11.1 * Math.exp(-0.087 * theta) + 1.1 * Math.exp(-0.014 * theta);
  const sumcos = cos_sza + cos_vza;
  const rclean = 1.247 + 1.186 * sumcos + 5.157 * cos_sza * cos_vza + pz;
  return rclean / 4 / sumcos;
}

function solver_wrapper(toa_cor_o3, t1, t2, r0, ak1, ak2, ratm, r) {
  return zbrent(0.1, 1, args = [t1, t2, r0, ak1, ak2, ratm, r, toa_cor_o3], max_iter = 30, tolerance = 2e-4);
}

function zbrent(x0, x1, args, max_iter = 100, tolerance = 1e-6) {
  let fx0 = f(x0, ...args = args);
  let fx1 = f(x1, ...args = args);
  if ((fx0 * fx1) &gt; 0) {
    return -999;
  }
  if (Math.abs(fx0) &lt; Math.abs(fx1)) {
    [x0, x1] = [x1, x0];
    [fx0, fx1] = [fx1, fx0];
  }
  let [x2, fx2] = [x0, fx0];
  let d = x2;
  let mflag = true;
  let steps_taken = 0;
  while (steps_taken &lt; max_iter &amp;&amp; Math.abs(x1 - x0) &gt; tolerance) {
    fx0 = f(x0, ...args = args);
    fx1 = f(x1, ...args = args);
    fx2 = f(x2, ...args = args);

    if (fx0 != fx2 &amp;&amp; fx1 != fx2) {
      let L0 = (x0 * fx1 * fx2) / ((fx0 - fx1) * (fx0 - fx2));
      let L1 = (x1 * fx0 * fx2) / ((fx1 - fx0) * (fx1 - fx2));
      let L2 = (x2 * fx1 * fx0) / ((fx2 - fx0) * (fx2 - fx1));
      var new_value = L0 + L1 + L2;
    } else {
      var new_value = x1 - ((fx1 * (x1 - x0)) / (fx1 - fx0));
    }

    if (
      (new_value &lt; ((3 * x0 + x1) / 4) || new_value &gt; x1) ||
      (mflag == true &amp;&amp; (Math.abs(new_value - x1)) &gt;= (Math.abs(x1 - x2) / 2)) ||
      (mflag == false &amp;&amp; (Math.abs(new_value - x1)) &gt;= (Math.abs(x2 - d) / 2)) ||
      (mflag == true &amp;&amp; (Math.abs(x1 - x2)) &lt; tolerance) ||
      (mflag == false &amp;&amp; (Math.abs(x2 - d)) &lt; tolerance)
    ) {
      new_value = (x0 + x1) / 2;
      mflag = true;
    } else {
      mflag = false;
    }

    let fnew = f(new_value, ...args = args);
    [d, x2] = [x2, x1];

    if (fx0 * fnew &lt; 0) {
      x1 = new_value;
    } else {
      x0 = new_value;
    }

    if (Math.abs(fx0) &lt; Math.abs(fx1)) {
      [x0, x1] = [x1, x0];
    }

    steps_taken += 1;
  }
  return x1;
}

// not used?
function f(albedo, t1, t2, r0, ak1, ak2, ratm, r, toa_cor_o3) {
  const surf = t1 * t2 * r0 * albedo ** (ak1 * ak2 / r0) / (1 - albedo * ratm);
  const rs = r + surf
  return toa_cor_o3 - rs;
}
&quot;&quot;&quot;

logging.info(&quot;Configuration ok.&quot;)    </code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="AmDGg7BOSr4VLkSeEuQMP" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:11 [INFO] root - Configuration ok.
</span></code></pre></div></div></div></div><div id="Am6TPMDBW7" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">date_range = (f&#x27;{date}T8:00:00&#x27;, f&#x27;{date}T18:00:00&#x27;)

DATE_FOLDER = date.replace(&quot;-&quot;,&quot;_&quot;)
DL_FOLDER =  os.path.join(&#x27;downloads&#x27;, str(resolution), DATE_FOLDER)
PROCESSED_FOLDER = f&#x27;{DL_FOLDER}/processed&#x27;

DATE_FOLDER</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="CqAupYhsOfcxb7KJuu0_A" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-text" class="font-mono text-sm whitespace-pre-wrap myst-jp-safe-output-text"><code><span>&#x27;2021_07_09&#x27;</span></code></div></div></div><div id="XjxblpeoKN" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">aoi_gpd = gpd.GeoDataFrame(geometry=[wkt.loads(aoi)], crs = &quot;EPSG:4326&quot;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="ncA6hsVbfSiMDahozbliJ" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="H3k7ruJ1Jr" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># load the 1 degree world grid from which the tiles will be calculated
logging.info(&quot;Loading grid&quot;)
grid = gpd.read_file(os.environ[&quot;DATA_PATH&quot;] + &quot;/wgs84-1degree.geojson&quot;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="T5Za5L9updUDNaBCTXRnq" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:35 [INFO] root - Loading grid
</span></code></pre></div></div></div></div><div id="HP3OwmacWa" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">logging.info(&quot;Calculating tiles to be processed.&quot;)    

# make the intersection with the polygon so that we only calculate tiles inside the polygon
toProcess=gpd.overlay(aoi_gpd, grid, how=&#x27;intersection&#x27;)

#Remove chunks that are too small to be processed
MIN_AREA = 1e-1
toProcess = toProcess[toProcess.geometry.to_crs(&#x27;epsg:4326&#x27;).area &gt; MIN_AREA]</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="V7G9tGVCns6ovaGc-ukzn" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:39 [INFO] root - Calculating tiles to be processed.
/tmp/ipykernel_386/667727171.py:8: UserWarning: Geometry is in a geographic CRS. Results from &#x27;area&#x27; are likely incorrect. Use &#x27;GeoSeries.to_crs()&#x27; to re-project geometries to a projected CRS before this operation.

  toProcess = toProcess[toProcess.geometry.to_crs(&#x27;epsg:4326&#x27;).area &gt; MIN_AREA]
</span></code></pre></div></div></div></div><div id="d2rwMkCWvX" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># use full frames
toProcess = grid[grid.ID.isin(list(toProcess.ID.values))]</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="PxWvwpB6gZPURdjWPZ4zG" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="bKvXW0vCyB" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">if DELETE_DOWNLOAD_FOLDER and os.path.exists(DL_FOLDER):
    shutil.rmtree(DL_FOLDER)
    logging.info(f&#x27;Folder {DL_FOLDER} deleted&#x27;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="SrDkJsXL0tDjhpUrROz1w" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:46 [INFO] root - Folder downloads/1200/2021_07_09 deleted
</span></code></pre></div></div></div></div><div id="MPMrV333GS" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">listBbox = [BBox(bbox=geom, crs=&quot;EPSG:4326&quot;) for geom in toProcess.geometry]
listSizes = [bbox_to_dimensions(bbox, resolution=resolution) for bbox in listBbox]
folderPaths = [f&#x27;{DL_FOLDER}/{round(id)}&#x27; for id in toProcess.ID]</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="inLM3KYcBaHPsHy57wT-O" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>/home/88c8cc07-d79c-45b9-a407-ba18967711b0/.local/lib/python3.9/site-packages/sentinelhub/geometry.py:113: SHDeprecationWarning: Initializing `BBox` objects from `shapely` geometries will no longer be possible in future versions. Use the `bounds` property of the `shapely` geometry to initialize the `BBox` instead.
  x_fst, y_fst, x_snd, y_snd = BBox._to_tuple(bbox)
</span></code></pre></div></div></div></div><div id="OjgAbNhUbO" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">requests = [SentinelHubRequest(
            evalscript=evalscript,
            data_folder=folderPath,
            input_data=[
                SentinelHubRequest.input_data(
                    data_collection=DataCollection.DEM_COPERNICUS_30,
                    identifier=&quot;COP_30&quot;,
                    upsampling=&quot;NEAREST&quot;,
                    downsampling=&quot;NEAREST&quot;,
                ),
                SentinelHubRequest.input_data(
                    data_collection=DataCollection.SENTINEL3_OLCI,
                    identifier=&quot;OLCI&quot;,
                    time_interval=date_range,
                    upsampling=&quot;NEAREST&quot;,
                    downsampling=&quot;NEAREST&quot;,
                ),
            ],
            responses=[
                SentinelHubRequest.output_response(&#x27;r_TOA_01&#x27;, MimeType.TIFF),
                SentinelHubRequest.output_response(&#x27;r_TOA_06&#x27;, MimeType.TIFF),
                SentinelHubRequest.output_response(&#x27;r_TOA_17&#x27;, MimeType.TIFF),
                SentinelHubRequest.output_response(&#x27;r_TOA_21&#x27;, MimeType.TIFF),
                SentinelHubRequest.output_response(&#x27;snow_grain_diameter&#x27;, MimeType.TIFF),
                SentinelHubRequest.output_response(&#x27;snow_specific_surface_area&#x27;, MimeType.TIFF),
                SentinelHubRequest.output_response(&#x27;diagnostic_retrieval&#x27;, MimeType.TIFF),
                SentinelHubRequest.output_response(&#x27;albedo_bb_planar_sw&#x27;, MimeType.TIFF),
                SentinelHubRequest.output_response(&#x27;albedo_bb_spherical_sw&#x27;, MimeType.TIFF),
            ],
            bbox=bb,
            size=size,
            config=sh_config
        ) for bb, size, folderPath in zip(listBbox, listSizes, folderPaths)]

#extract only downloader
list_of_requests = [request.download_list[0] for request in requests]</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="qcOfOrA-n_MomXbGTC5M5" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="kdg1JDkK1l" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">logging.info(&#x27;Starting download&#x27;)
downloader = SentinelHubDownloadClient(config=sh_config)
downloader.download(list_of_requests, max_threads=20, show_progress=False)
logging.info(&#x27;Done&#x27;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="AUu7lKHpo2zKTAQkuf3bc" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:46 [INFO] root - Starting download
2023-03-07 14:49:50 [INFO] root - Done
</span></code></pre></div></div></div></div><div id="zlHdwwJx1H" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">def unzipFile(file, destination):
    if not os.path.exists(os.path.join(destination, &#x27;snow_grain_diameter.tif&#x27;)):
        tar = tarfile.open(file, &quot;r:&quot;)
        tar.extractall(path=destination)
        tar.close()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="-gPfO5bTO08HppBHRHUde" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="Of5Rf3rYaR" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">class ConcurrentUnzipper:
    def __init__(self, files, destinations):
        self.files = files
        self.destinations = destinations
        
    def operation(self, chunk):
        unzipFile(self.files[chunk] , self.destinations[chunk])
        
    def unzipAll(self):
        with concurrent.futures.ProcessPoolExecutor() as executor:
            list(executor.map(self.operation, np.arange(0, len(self.files)), chunksize=1))</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="AwXO-S3opBm2egCnd5qk2" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="PK6D9UTrBX" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">filenamesList = glob.glob(f&#x27;./{DL_FOLDER}/*/*/response.tar&#x27;)
destinations =  [file.replace(&#x27;response.tar&#x27;, &#x27;&#x27;) for file in filenamesList]        
        
logging.info(&#x27;Extracting .tar responses&#x27;)
unzipper = ConcurrentUnzipper(filenamesList, destinations)
unzipper.unzipAll()
logging.info(&#x27;Done&#x27;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="3obrfyVuKsa2DzSxyeeT7" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:50 [INFO] root - Extracting .tar responses
2023-03-07 14:49:50 [INFO] root - Done
</span></code></pre></div></div></div></div><div id="zB0FtGQBXQ" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">def mergeProduct(productName):
    prodResult = productName.replace(&quot;.tif&quot;, &#x27;_merged.tif&#x27;)
    if os.path.exists(prodResult):
        os.remove(prodResult)
        logging.info(f&#x27;Deleted file: {prodResult}&#x27;)
    filenamesList = glob.glob(f&#x27;./{DL_FOLDER}/*/*/{productName}&#x27;)
    merge_tiffs(filenamesList, prodResult, overwrite=True)
     
class TifMerger:
    def __init__(self, products):
        self.products = products
        
    def operation(self, chunk):
        mergeProduct(self.products[chunk])
        
    def process(self):
        with concurrent.futures.ProcessPoolExecutor() as executor:
            list(executor.map(self.operation, np.arange(0, len(self.products)), chunksize=1))    </code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="2kU4RmkJsrWtXpZjIke7C" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="t5p4CtwK3e" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">#define the products that will be computed
products = [&#x27;diagnostic_retrieval.tif&#x27;,&#x27;albedo_bb_planar_sw.tif&#x27;,&#x27;albedo_bb_spherical_sw.tif&#x27;,&#x27;snow_grain_diameter.tif&#x27;, &#x27;snow_specific_surface_area.tif&#x27;, &#x27;r_TOA_01.tif&#x27;, &#x27;r_TOA_06.tif&#x27;, &#x27;r_TOA_17.tif&#x27;, &#x27;r_TOA_21.tif&#x27;]
#products = [&#x27;snow_grain_diameter.tif&#x27;]

#merge individual tiles into one single image
logging.info(&#x27;Merging products&#x27;)
unzipper = TifMerger(products)
unzipper.process()
logging.info(&#x27;Done&#x27;)    

resultsDataPath = os.path.join(USR_PATH, PROCESSED_FOLDER)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="_gF8xK5jHqVUvw8X6TMA6" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:50 [INFO] root - Merging products
2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to albedo_bb_planar_sw_merged.tif
2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to r_TOA_17_merged.tif
2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to diagnostic_retrieval_merged.tif
2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to r_TOA_06_merged.tif
2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to albedo_bb_spherical_sw_merged.tif
2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to snow_specific_surface_area_merged.tif
2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to snow_grain_diameter_merged.tif
2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to r_TOA_01_merged.tif
</span></code></pre></div></div><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>00000000</span></code></pre></div></div><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:52 [INFO] root - merging done
2023-03-07 14:49:52 [INFO] root - merging 4 tiffs to r_TOA_21_merged.tif
2023-03-07 14:49:52 [INFO] root - merging done
2023-03-07 14:49:52 [INFO] root - merging done
</span></code></pre></div></div><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>...10...20.....10...20...30...40...50...60...70.....10...20.....10...20...30...40...50...10...20.....60...70.....10...20.....10...20...80...90...100 - done.
...10...20...30...40...50.30...40...50...60...70.....60...70...30...40...50...60...70...80...90...100 - done.
.30...40...50.30...40...50...60...70.....60...70...30...40...50...60...70...80...90...100 - done.
.80...90...100 - done.
.80...90...100 - done.
.80...90...100 - done.
.80...90...100 - done.
.80...90...100 - done.
</span></code></pre></div></div><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:52 [INFO] root - merging done
2023-03-07 14:49:52 [INFO] root - merging done
2023-03-07 14:49:52 [INFO] root - merging done
2023-03-07 14:49:52 [INFO] root - merging done
2023-03-07 14:49:52 [INFO] root - merging done
</span></code></pre></div></div><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>0</span></code></pre></div></div><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>2023-03-07 14:49:52 [INFO] root - merging done
2023-03-07 14:49:52 [INFO] root - Done
</span></code></pre></div></div><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>...10...20...30...40...50...60...70...80...90...100 - done.
</span></code></pre></div></div></div></div><div id="ajV1N7ZNqr" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">if not os.path.exists(PROCESSED_FOLDER):
    os.makedirs(PROCESSED_FOLDER)
    
producedFiles = glob.glob(&#x27;*_merged.tif&#x27;)
for prodResult in producedFiles:
    shutil.move(prodResult, f&#x27;{PROCESSED_FOLDER}/{prodResult}&#x27;)
    
resultsDataPath = os.path.join(USR_PATH, PROCESSED_FOLDER)
resultsDataPath</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="zJcqcItyGP_PpbHYLTban" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-text" class="font-mono text-sm whitespace-pre-wrap myst-jp-safe-output-text"><code><span>&#x27;/home/88c8cc07-d79c-45b9-a407-ba18967711b0/downloads/1200/2021_07_09/processed&#x27;</span></code></div></div></div><div id="KCTFsJCfK8" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">processedDataPath = os.path.join(USR_PATH, PROCESSED_FOLDER)
if len(projection) &gt; 0 and not projection == &#x27;4326&#x27; : 
    destFolder = f&#x27;{DL_FOLDER}/warped/&#x27;

    logging.info(&#x27;Reprojecting to epsg:{projection}&#x27;)
    
    if os.path.exists(destFolder):
        shutil.rmtree(destFolder)

    os.makedirs(destFolder)

    for product in products:
        srcFile = processedDataPath + &quot;/&quot; + product.replace(&quot;.tif&quot;, &quot;_merged.tif&quot;)
        destFile = f&#x27;{destFolder}/{product}&#x27;
        cmd = f&#x27;gdalwarp {srcFile} {destFile}  -t_srs EPSG:{projection}&#x27;
        os.system(cmd)
   
    resultsDataPath = destFolder
else:
    for product in products:
        srcFile = processedDataPath + &quot;/&quot; + product.replace(&quot;.tif&quot;, &quot;_merged.tif&quot;)
        destFile = processedDataPath + &quot;/&quot; + product
        if os.path.exists(srcFile):
            os.rename(srcFile, destFile)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="t4l3IkEp0teR9lme65I5q" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div class="myst-backmatter-parts"></div></article></main><script>((a,l)=>{if(!window.history.state||!window.history.state.key){let u=Math.random().toString(32).slice(2);window.history.replaceState({key:u},"")}try{let d=JSON.parse(sessionStorage.getItem(a)||"{}")[l||window.history.state.key];typeof d=="number"&&window.scrollTo(0,d)}catch(u){console.error(u),sessionStorage.removeItem(a)}})("positions", null)</script><link rel="modulepreload" href="/polartep_notebooks/build/entry.client-PCJPW7TK.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-AQ2CODAG.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-JJXTQVMA.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-OZE3FFNP.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-CH4FVTDV.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-C4DFGG5C.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-J7TUH54J.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-FZ2S7OYD.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-JEM6JXYA.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-34XIY2DH.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-KQM5FBHR.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-OCWQY3HK.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-7HNKBP4B.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-CUKUDK3R.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-3EBOCCHJ.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-O4VQNZ62.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-4OEDG4JQ.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-GUCIBHGO.js"/><link rel="modulepreload" href="/polartep_notebooks/build/root-SIO6LUTY.js"/><link rel="modulepreload" href="/polartep_notebooks/build/_shared/chunk-FAHZZXAC.js"/><link rel="modulepreload" href="/polartep_notebooks/build/routes/$-PRP77N34.js"/><script>window.__remixContext = {"url":"/notebooks/sice","state":{"loaderData":{"root":{"config":{"version":3,"myst":"1.8.0","options":{"hide_toc":true,"hide_footer_links":true,"folders":true},"nav":[],"actions":[],"projects":[{"subject":"Notebook examples","title":"PolarTEP Notebooks","description":"Collection of examples relevant to the PolarTEP","github":"https://github.com/gtif-cerulean/polartep_notebooks","id":"5aa0318b-5bc1-41e2-b1d4-053e8b61961b","exports":[],"bibliography":[],"index":"readme","pages":[{"title":"Notebooks","level":1},{"slug":"notebooks.ccadi-uc3","title":"Ccadi U C3","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.sice","title":"Sentinel-3 Snow and ICE products (SICE)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.xcube-tutorial","title":"PolarTEP eScience Lab:  Using XCube in Polar-TEP to Generate NDVI","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}]},"CONTENT_CDN_PORT":"3100","MODE":"static","BASE_URL":"/polartep_notebooks"},"routes/$":{"config":{"version":3,"myst":"1.8.0","options":{"hide_toc":true,"hide_footer_links":true,"folders":true},"nav":[],"actions":[],"projects":[{"subject":"Notebook examples","title":"PolarTEP Notebooks","description":"Collection of examples relevant to the PolarTEP","github":"https://github.com/gtif-cerulean/polartep_notebooks","id":"5aa0318b-5bc1-41e2-b1d4-053e8b61961b","exports":[],"bibliography":[],"index":"readme","pages":[{"title":"Notebooks","level":1},{"slug":"notebooks.ccadi-uc3","title":"Ccadi U C3","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.sice","title":"Sentinel-3 Snow and ICE products (SICE)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.xcube-tutorial","title":"PolarTEP eScience Lab:  Using XCube in Polar-TEP to Generate NDVI","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}]},"page":{"version":3,"kind":"Notebook","sha256":"d8cce1e111053bf78e2803ac6d59c5c6c52cfc35abc1abd15b96294a07d9ff69","slug":"notebooks.sice","location":"/notebooks/SICE.ipynb","dependencies":[],"frontmatter":{"title":"Sentinel-3 Snow and ICE products (SICE)","content_includes_title":false,"kernelspec":{"name":"conda-env-bids2023-bids2023-py","display_name":"bids2023-bids2023","language":"python"},"github":"https://github.com/gtif-cerulean/polartep_notebooks","subject":"Notebook examples","numbering":{"title":{"offset":1}},"source_url":"https://github.com/gtif-cerulean/polartep_notebooks/blob/main/notebooks/SICE.ipynb","edit_url":"https://github.com/gtif-cerulean/polartep_notebooks/edit/main/notebooks/SICE.ipynb","exports":[{"format":"ipynb","filename":"SICE.ipynb","url":"/polartep_notebooks/build/SICE-ae55454ca1e83a85c4659a3885d511f3.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","data":{"collapsed":true,"jupyter":{"outputs_hidden":true},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"#%run ./prepare-sice-environment.ipynb\n! pip install --upgrade sentinelhub ","visibility":"show","key":"zRPt9a9HUy"},{"type":"outputs","id":"9_-JQ8CC5kPBJNFbVLgqs","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Defaulting to user installation because normal site-packages is not writeable\nRequirement already satisfied: sentinelhub in ./.local/lib/python3.9/site-packages (3.8.4)\nRequirement already satisfied: aenum\u003e=2.1.4 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (3.1.11)\nRequirement already satisfied: requests-oauthlib\u003e=1.0.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (1.3.1)\nRequirement already satisfied: numpy in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (1.23.5)\nRequirement already satisfied: typing-extensions in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (4.4.0)\nRequirement already satisfied: tifffile\u003e=2020.9.30 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (2022.10.10)\nRequirement already satisfied: shapely in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (1.8.5.post1)\nRequirement already satisfied: oauthlib in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (3.2.2)\nRequirement already satisfied: tqdm in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (4.64.1)\nRequirement already satisfied: requests\u003e=2.27.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (2.28.1)\nRequirement already satisfied: python-dateutil in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (2.8.2)\nRequirement already satisfied: utm in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (0.7.0)\nRequirement already satisfied: dataclasses-json in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (0.5.7)\nRequirement already satisfied: pillow\u003e=9.2.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (9.2.0)\nRequirement already satisfied: click in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (8.0.4)\nRequirement already satisfied: pyproj\u003e=2.2.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from sentinelhub) (3.4.0)\nRequirement already satisfied: certifi in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from pyproj\u003e=2.2.0-\u003esentinelhub) (2022.9.24)\nRequirement already satisfied: urllib3\u003c1.27,\u003e=1.21.1 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from requests\u003e=2.27.0-\u003esentinelhub) (1.26.13)\nRequirement already satisfied: charset-normalizer\u003c3,\u003e=2 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from requests\u003e=2.27.0-\u003esentinelhub) (2.1.1)\nRequirement already satisfied: idna\u003c4,\u003e=2.5 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from requests\u003e=2.27.0-\u003esentinelhub) (3.4)\nRequirement already satisfied: marshmallow-enum\u003c2.0.0,\u003e=1.5.1 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from dataclasses-json-\u003esentinelhub) (1.5.1)\nRequirement already satisfied: marshmallow\u003c4.0.0,\u003e=3.3.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from dataclasses-json-\u003esentinelhub) (3.19.0)\nRequirement already satisfied: typing-inspect\u003e=0.4.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from dataclasses-json-\u003esentinelhub) (0.8.0)\nRequirement already satisfied: six\u003e=1.5 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from python-dateutil-\u003esentinelhub) (1.16.0)\nRequirement already satisfied: packaging\u003e=17.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from marshmallow\u003c4.0.0,\u003e=3.3.0-\u003edataclasses-json-\u003esentinelhub) (21.3)\nRequirement already satisfied: mypy-extensions\u003e=0.3.0 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from typing-inspect\u003e=0.4.0-\u003edataclasses-json-\u003esentinelhub) (0.4.3)\nRequirement already satisfied: pyparsing!=3.0.5,\u003e=2.0.2 in /home/conda/eurodatacube/509ef1ea91778cd89e0732da937c672a0e4c27fd9e360fadaa9831b15c3fb15c-20221207-163604-486302-65-edc-2022.10-14/lib/python3.9/site-packages (from packaging\u003e=17.0-\u003emarshmallow\u003c4.0.0,\u003e=3.3.0-\u003edataclasses-json-\u003esentinelhub) (3.0.9)\n"},"children":[],"key":"zIjHuiLiRn"}],"visibility":"show","key":"Bze6YThl0X"}],"visibility":"show","key":"fmtiNwEvCL"},{"type":"block","kind":"notebook-code","data":{"papermill":{"duration":1.161156,"end_time":"2021-05-11T14:54:55.668650","exception":false,"start_time":"2021-05-11T14:54:54.507494","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"\n## Credentials needs to be filled in the code in order to make it work!\n\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport os\nimport logging\nimport subprocess\nfrom botocore.client import Config as botoConfig\nfrom botocore.exceptions import ClientError\nfrom oauthlib.oauth2 import BackendApplicationClient\nfrom requests_oauthlib import OAuth2Session\nimport boto3\nimport glob\nimport time\nimport rasterio\nfrom shapely import geometry\nfrom osgeo import ogr\n\nlogging = logging.getLogger(__name__)\n\ndef plot_image(image, factor=1.0, clip_range=None, **kwargs):\n    \"\"\"\n    Utility function for plotting RGB images.\n    \"\"\"\n    fig, ax = plt.subplots(nrows=1, ncols=1, figsize=(15, 15))\n    if clip_range is not None:\n        ax.imshow(np.clip(image * factor, *clip_range), **kwargs)\n    else:\n        ax.imshow(image * factor, **kwargs)\n    ax.set_xticks([])\n    ax.set_yticks([])\n    \n    \ndef merge_tiffs(input_filename_list, merged_filename, *, overwrite=False, delete_input=False):\n    \"\"\"Performs gdal_merge on a set of given geotiff images\n\n    :param input_filename_list: A list of input tiff image filenames\n    :param merged_filename: Filename of merged tiff image\n    :param overwrite: If True overwrite the output (merged) file if it exists\n    :param delete_input: If True input images will be deleted at the end\n    \"\"\"\n    if os.path.exists(merged_filename):\n        if overwrite:\n            os.remove(merged_filename)\n        else:\n            raise OSError(f\"{merged_filename} exists!\")\n\n    logging.info(\"merging %d tiffs to %s\", len(input_filename_list), merged_filename)\n    subprocess.check_call(\n        [\"gdal_merge.py\", \"-co\", \"BIGTIFF=YES\", \"-co\", \"compress=LZW\", \"-ot\", \"Float32\" , \"-init\", \"-9999\" , \"-n\", \"-9999\", \"-a_nodata\", \"-9999\", \"-o\", merged_filename, *input_filename_list]\n    )\n    logging.info(\"merging done\")\n\n    if delete_input:\n        logging.info(\"deleting input files\")\n        for filename in input_filename_list:\n            if os.path.isfile(filename):\n                os.remove(filename)\n                \ndef deleteProcessingData(dir):\n    logging.info(f'Deleting files from {dir}')\n    for file in glob.glob(f'{dir}/*_tmp.tif'):\n        logging.info(f'Deleting file {file}')\n        os.remove(file)\n\ndef importToBucket(awsConfig, resultsFolder, processBands=False):\n    \n    try:\n        s3_client = boto3.resource('s3',\n                                   endpoint_url=awsConfig['s3Url'],\n                                   use_ssl=False,\n                                   aws_access_key_id=awsConfig['s3AccessKey'],\n                                   aws_secret_access_key=awsConfig['s3SecrestKey'],\n                                   config=botoConfig(\n                                       signature_version='s3',\n                                       connect_timeout=60,\n                                       read_timeout=60,\n                                   ))\n\n        bucket = s3_client.Bucket(awsConfig['bucketName'])\n    except Exception as e:\n        logging.error(e)\n        raise Exception('Invalid bucket parameters') \n    \n    coverGeometry = ''\n    \n    # get tif files to upload\n    filenamesList = glob.glob(f'{resultsFolder}/*.tif')\n    try:\n        for file in filenamesList:\n            destFile = file.replace(resultsFolder, awsConfig['folder'])\n            if processBands:\n                tmpFile = file.replace(\".tif\", \"_tmp.tif\")\n                cmd = \"gdal_translate -b 1 -of COG -a_nodata -9999 -co COMPRESS=DEFLATE -co BLOCKSIZE=1024 -co RESAMPLING=AVERAGE -co OVERVIEWS=IGNORE_EXISTING {0} {1}\".format(file, tmpFile)\n                logging.info(cmd)\n                os.system(cmd)\n                file = tmpFile\n                \n            if not coverGeometry:\n                coverGeometry = getMbrWithIntermediate(file)\n            \n            logging.info(f'Uploading {file} to {destFile}')\n            response = bucket.upload_file(file, destFile)\n        deleteProcessingData(resultsFolder)\n    except Exception as e:\n        logging.error(e)\n        raise Exception(f'Failed to upload file: {destFile}') \n        \n    return coverGeometry\n\ndef addIntermediateY(x, y, diff, numPoints):\n    coords = []\n    coords.append([x, y])  \n    for i in range(numPoints):\n        coords.append([x, y + i / numPoints * diff])\n    return coords\n\ndef addIntermediateX(x, y, diff, numPoints):\n    coords = []\n    coords.append([x, y])  \n    for i in range(numPoints):\n        coords.append([x + i / numPoints * diff, y])\n    return coords\n\ndef getMbrWithIntermediate(file):\n    dataset = rasterio.open(file)\n    bounds = dataset.bounds\n    poly = getPolygonFromMbr(bounds.left, bounds.bottom, bounds.right, bounds.top, 20)\n    p = geometry.mapping(poly)\n    p['properties'] = {'name': 'urn:ogc:def:crs:EPSG::4326'}\n    return p         \n        \ndef getPolygonFromMbr(xMin, yMin, xMax, yMax, numPoints):\n    coords = []\n    xDiff = xMax - xMin\n    yDiff = yMax - yMin\n    \n    coords.extend(addIntermediateY(xMin, yMin, yDiff, numPoints))\n    coords.extend(addIntermediateX(xMin, yMax, xDiff, numPoints))\n    coords.extend(addIntermediateY(xMax, yMax, -yDiff, numPoints))\n    coords.extend(addIntermediateX(xMax, yMin, -xDiff, numPoints))\n    poly = geometry.Polygon(coords)\n    return poly        \n        \ndef deleteTile(s3folder, oauth, byocUrl):\n    url = f'{byocUrl}/tiles'\n\n    try:\n        while url is not None:\n            print(f'Calling url: {url}')\n            response = oauth.get(url)\n            response.raise_for_status()\n\n            output = response.json()\n            tiles = output['data']\n            links = output['links']\n\n            for tile in tiles:\n                if tile['path'].startswith(s3folder):\n                    tile_id = tile['id']\n                    response = oauth.delete(f'{byocUrl}/tiles/{tile_id}')\n                    print(\"Deleted tile: \" + tile['path'])\n                    try:\n                        response.raise_for_status()\n                    except Exception as e:\n                        print(\"Failed to delete tile {0}: {1}\".format(\n                            tile_id, response.reason))\n                        logging.error(e)\n\n            # sets url to None if there's no link to the next set of tiles\n            url = links.get('next', None)\n\n            # waits a bit before fetching the next set\n            time.sleep(0.1)\n    except Exception as e:\n        logging.error(\"BYOC delete error: {0}\".format(response.reason))\n        logging.error(e)\n        raise\n\ndef insertTile(tile, oauth, byocUrl):\n    print(f'Inserting tile {tile}')\n    try:\n        response = oauth.post(f'{byocUrl}/tiles', json=tile)\n        response.raise_for_status()\n    except Exception as e:\n        logging.error(\"BYOC import error: {0}\".format(response.reason))\n        logging.error(e)\n\n\ndef importToBYOC(config):\n     # Create a session\n    client = BackendApplicationClient(client_id=config['client_id'])\n    oauth = OAuth2Session(client=client)\n    oauth.fetch_token(token_url='https://services.sentinel-hub.com/oauth/token',\n                      client_id=['client_id'], client_secret=config['client_secret'])\n\n    byoc_service_base_url = config['byoc_service_base_url']\n    collection_id = config['collection_id']\n    byocUrl = f'{byoc_service_base_url}/collections/{collection_id}'\n    \n    # ingest tile\n    tilePath = config['folder']\n    tile = {\n        'path': tilePath,\n        'sensingTime': config['sensingTime'],\n        'coverGeometry' : config['coverGeometry']\n    }\n    \n    if config['coverGeometry']: \n         tile ['coverGeometry'] = config['coverGeometry']\n            \n    logging.info(\"Deleting folder: \" + tilePath)\n    deleteTile(tilePath, oauth, byocUrl)\n    logging.info(\"Ingesting folder: \" + tilePath)\n    insertTile(tile, oauth, byocUrl)\n    \n    \ndef defaultBYOCImport(resultsFolder, s3Folder, resolution, sensingTime):\n    if not (resolution == 300 or resolution == 500) :\n        logger.info('Resolution not supported.')\n        return\n    \n    s3config = {\n        's3Url' : 'https://s3.waw2-1.cloudferro.com',\n        's3AccessKey' : 'xxx',\n        's3SecrestKey' : 'xxx',\n        'bucketName' : 'polar',\n        'folder' : s3Folder,\n    }\n    coverGeometry = importToBucket(s3config, resultsFolder, True)\n    \n    collectionID_300m = 'd34c470c-52a8-49db-9f9b-0956f10734d9'\n    collectionID_500m = '6a3a4f71-84ff-4421-95a7-6ba969b5cf88'\n    \n    collectionId = collectionID_300m if resolution == 300 else collectionID_500m\n    \n    shConfig = {\n        'byoc_service_base_url' : 'https://creodias.sentinel-hub.com/api/v1/byoc',\n        'client_id' : 'xxx',\n        'client_secret' : 'xxx',\n        'collection_id' : collectionId,\n        'folder' : s3Folder,\n        'sensingTime' : sensingTime,\n        'coverGeometry' : coverGeometry\n    }    \n    importToBYOC(shConfig)","visibility":"show","key":"xgu89gNW3H"},{"type":"outputs","id":"c0EnBBF_3nO8avoy-T2ar","children":[],"visibility":"show","key":"QP23rNFKpb"}],"visibility":"show","key":"akMoF5ezv4"},{"type":"block","kind":"notebook-code","data":{"papermill":{"duration":1.161156,"end_time":"2021-05-11T14:54:55.668650","exception":false,"start_time":"2021-05-11T14:54:54.507494","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Various utilities\nimport os\nimport json\nfrom shapely import geometry, wkt\nimport datetime as dt\nimport numpy as np\nimport geopandas as gpd\nimport glob\nimport shutil\nimport logging\nimport concurrent.futures\nimport time\n\nfrom sentinelhub import SentinelHubDownloadClient, SentinelHubBatch, SentinelHubRequest, Geometry, CRS, DataCollection, MimeType, SHConfig, BBox, bbox_to_dimensions\nfrom shapely.geometry import Polygon\nimport tarfile\n\n# create logs folder\nif not os.path.exists(\"logs\"):\n    os.makedirs(\"logs\")\n\n# right now we only log to consol\nlogging.basicConfig(\n    format='%(asctime)s [%(levelname)s] %(name)s - %(message)s',\n    level=logging.INFO,\n    datefmt='%Y-%m-%d %H:%M:%S',\n    handlers=[\n        logging.FileHandler(f'logs/sice_sh_{time.strftime(\"%Y_%m_%d\",time.localtime())}.log'),\n        logging.StreamHandler()\n    ])","visibility":"show","key":"Fju4xJnm3M"},{"type":"outputs","id":"Z90H7sK9qIbMyfGw64aue","children":[],"visibility":"show","key":"LnEFptJCIW"}],"visibility":"show","key":"IA92mRsso1"},{"type":"block","kind":"notebook-code","data":{"tags":["parameters"]},"children":[{"type":"code","lang":"python","executable":true,"value":"#External variables\n# Set the date of calculation\ndate = \"2021-07-09\"\n\n# resolution (m) \nresolution = 1200  # minimum resolution of data is 300m\n\n#area of interest\naoi = 'POLYGON((-53.6565 82.4951, -59.9608 82.1309, -67.7892 80.5602, -67.9606 80.0218, -67.6072 79.3014, -72.7375 78.5894, -73.5413 78.1636, -72.9428 77.3837, -69.0700 76.0128, -66.6509 75.7624, -60.3956 75.8231, -58.4311 74.8854, -55.1967 69.6980, -53.8565 68.8368, -54.2986 67.0754, -53.5562 65.6109, -52.3863 64.7989, -52.3228 64.0074, -50.2076 62.1010, -48.6300 60.7381, -45.0522 59.7674, -43.2890 59.6436, -42.4957 60.3093, -41.8486 61.5655, -41.6969 62.6486, -40.1106 63.5452, -39.9111 64.7944, -38.0777 65.4068, -36.9899 65.1987, -31.2165 67.7166, -25.8502 68.6303, -21.6517 70.0839, -20.9932 70.7880, -21.2829 72.9254, -16.9050 74.9601, -17.1213 79.6158, -10.2883 81.4244, -14.0398 81.9745, -17.8112 82.0131, -28.5252 83.7013, -40.1075 83.6651, -53.6565 82.4951))'\naoi = \"POLYGON ((-14.675905 65.792421, -14.675905 66.238873, -13.423464 66.238873, -13.423464 65.792421, -14.675905 65.792421))\"\n#sub-area\n#aoi = 'POLYGON ((-56.045995 66.271911, -49.369389 66.271911, -49.369389 71.949832, -56.045995 71.949832, -56.045995 66.271911))'\n\n#Island\n#aoi = 'POLYGON ((-24.634498 66.588207, -13.38895 66.588207, -13.38895 63.292939, -24.634498 63.292939, -24.634498 66.588207))'\n\n#target projection of the final results\nprojection = '4326' #default\n\n#projection = '3413'  #polar\n \n\n# log processing parameters - don't log any S3 information\nlogging.info(f'Date: {date}')\nlogging.info(f'AOI: {aoi}')\nlogging.info(f'Projection: {projection}')\n\n","visibility":"show","key":"VIBABoyxfx"},{"type":"outputs","id":"_BE4WAYk2-9VdG-uV5-zy","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:11 [INFO] root - Date: 2021-07-09\n2023-03-07 14:49:11 [INFO] root - AOI: POLYGON ((-14.675905 65.792421, -14.675905 66.238873, -13.423464 66.238873, -13.423464 65.792421, -14.675905 65.792421))\n2023-03-07 14:49:11 [INFO] root - Projection: 4326\n"},"children":[],"key":"RrrbgX8Cev"}],"visibility":"show","key":"gnIgjEZ9nd"}],"visibility":"show","key":"SzPHLZwPrD"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"#verify input parameters\n\nif not date:\n    raise Exception('variable date has to be set') \n\nif not aoi:\n    raise Exception('aoi has to be set')     \n\nif not resolution:\n    raise Exception('resolution has to be set')     \n\nif resolution \u003c 300 or resolution \u003e 1200: \n    raise Exception('value of resolution has to be between 200 m and 1200 m')\n\n#transform period into single day    \nif '/' in date:\n    date = date[0:date.find('/')]    ","visibility":"show","key":"lIoEA2sVw6"},{"type":"outputs","id":"PaBjqVU-p6pUEBzKPT7-q","children":[],"visibility":"show","key":"jemHERkDya"}],"visibility":"show","key":"FXJMQP7exX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#system settings\n\n#base folder where the code is located\nUSR_PATH = os.path.abspath('.')\nEVAL_SCRIPT_PATH = os.path.join(USR_PATH, 'data_fusion_olci_dem.js') \n\n#delete download folder after processing - will save space but will download all the data for each requwst (otherwise the cached tile data will be used)\nDELETE_DOWNLOAD_FOLDER = True\n\n#OUTPUT_DIR = os.path.join(USR_PATH, \"output\") #local folder\nOUTPUT_DIR = \"/home/jovyan/result-data\" # will be copied to the local folder of the user requesting the data\n\nlogging.info(\"System configuration ok.\")    \n","key":"pjQnpzSaw1"},{"type":"outputs","id":"WrVijfym8QgQjh23R4_S8","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:11 [INFO] root - System configuration ok.\n"},"children":[],"key":"MERuOcyLXa"}],"key":"IAiWN37TvE"}],"key":"Hs6fNHKtvi"},{"type":"block","kind":"notebook-code","data":{"papermill":{"duration":0.190306,"end_time":"2021-05-11T14:54:55.874185","exception":false,"start_time":"2021-05-11T14:54:55.683879","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# initial ENV configuration\nSH_CLIENT_ID = %env SH_CLIENT_ID\nSH_CLIENT_SECRET = %env SH_CLIENT_SECRET\n\nsh_config = SHConfig()\nsh_config.sh_base_url = \"https://services.sentinel-hub.com\"\nsh_config.download_timeout_seconds=300\nsh_config.download_sleep_time=20\n\nsh_config.sh_client_id = SH_CLIENT_ID\nsh_config.sh_client_secret = SH_CLIENT_SECRET\n\nsh_config.save()\n\n# Evalscript\nevalscript = \"\"\"\n//VERSION=3\nfunction setup() {\n  return {\n    input: [\n      {\n        datasource: \"OLCI\",\n        bands: [\"B01\", \"B02\", \"B03\", \"B04\", \"B05\", \"B06\", \"B07\", \"B08\", \"B09\", \"B10\", \"B11\", \"B12\", \"B13\", \"B14\", \"B15\", \"B16\", \"B17\", \"B18\", \"B19\", \"B20\", \"B21\", \"SZA\", \"VZA\", \"SAA\", \"VAA\", \"TOTAL_COLUMN_OZONE\"],\n      },\n      {\n        datasource: \"COP_30\",\n        bands: [\"DEM\"]\n      }\n    ],\n    output: [\n      {\n        id: \"r_TOA_01\",\n        bands: 1,\n        sampleType: \"FLOAT32\",\n      },\n      {\n        id: \"r_TOA_06\",\n        bands: 1,\n        sampleType: \"FLOAT32\",\n      },\n      {\n        id: \"r_TOA_17\",\n        bands: 1,\n        sampleType: \"FLOAT32\",\n      },\n      {\n        id: \"r_TOA_21\",\n        bands: 1,\n        sampleType: \"FLOAT32\",\n      },\n      {\n        id: \"snow_grain_diameter\",\n        bands: 1,\n        sampleType: \"FLOAT32\",\n      },\n      {\n        id: \"snow_specific_surface_area\",\n        bands: 1,\n        sampleType: \"FLOAT32\",\n      },\n      {\n        id: \"diagnostic_retrieval\",\n        bands: 1,\n        sampleType: \"UINT8\",\n      },\n      {\n        id: \"albedo_bb_planar_sw\",\n        bands: 1,\n        sampleType: \"FLOAT32\",\n      },\n      {\n        id: \"albedo_bb_spherical_sw\",\n        bands: 1,\n        sampleType: \"FLOAT32\",\n      }\n\n    ],\n    mosaicking: \"SIMPLE\",\n  };\n}\n\n//function updateOutput(outputs, collections) {\n//  Object.values(outputs).forEach((output) =\u003e {\n//    output.bands = collections.scenes.length;\n//  });\n//}\n\n// Set constants as global variables which can be used in all functions\nvar wls = {\n  \"B01\": 0.4000E+00,\n  \"B02\": 0.4125E+00,\n  \"B03\": 0.4425E+00,\n  \"B04\": 0.4900E+00,\n  \"B05\": 0.5100E+00,\n  \"B06\": 0.5600E+00,\n  \"B07\": 0.6200E+00,\n  \"B08\": 0.6650E+00,\n  \"B09\": 0.6737E+00,\n  \"B10\": 0.6812E+00,\n  \"B11\": 0.7088E+00,\n  \"B12\": 0.7538E+00,\n  \"B13\": 0.7613E+00,\n  \"B14\": 0.7644E+00,\n  \"B15\": 0.7675E+00,\n  \"B16\": 0.7788E+00,\n  \"B17\": 0.8650E+00,\n  \"B18\": 0.8850E+00,\n  \"B19\": 0.9000E+00,\n  \"B20\": 0.9400E+00,\n  \"B21\": 0.1020E+01\n};\n\nvar bai = {\n  \"B01\": 2.365E-11,\n  \"B02\": 2.7E-11,\n  \"B03\": 7.0E-11,\n  \"B04\": 4.17E-10,\n  \"B05\": 8.04E-10,\n  \"B06\": 2.84E-09,\n  \"B07\": 8.58E-09,\n  \"B08\": 1.78E-08,\n  \"B09\": 1.95E-08,\n  \"B10\": 2.1E-08,\n  \"B11\": 3.3E-08,\n  \"B12\": 6.23E-08,\n  \"B13\": 7.1E-08,\n  \"B14\": 7.68E-08,\n  \"B15\": 8.13E-08,\n  \"B16\": 9.88E-08,\n  \"B17\": 2.4E-07,\n  \"B18\": 3.64E-07,\n  \"B19\": 4.2E-07,\n  \"B20\": 5.53e-07,\n  \"B21\": 2.25E-06\n}\n\nlet emptyBandObject = {\n  \"B01\": {},\n  \"B02\": {},\n  \"B03\": {},\n  \"B04\": {},\n  \"B05\": {},\n  \"B06\": {},\n  \"B07\": {},\n  \"B08\": {},\n  \"B09\": {},\n  \"B10\": {},\n  \"B11\": {},\n  \"B12\": {},\n  \"B13\": {},\n  \"B14\": {},\n  \"B15\": {},\n  \"B16\": {},\n  \"B17\": {},\n  \"B18\": {},\n  \"B19\": {},\n  \"B20\": {},\n  \"B21\": {}\n}\n\nconst allBands = Object.keys(bai);\n\n// solar spectrum constants\nconst f0 = 32.38;\nconst f1 = -160140.33;\nconst f2 = 7959.53;\nconst bet = 1. / (85.34 * 1.e-3);\nconst gam = 1. / (401.79 * 1.e-3);\n\nvar coef1, coef2 = analyt_func(0.3, 0.7);\nvar coef3, coef4 = analyt_func(0.7, 0.865);\n\nfunction evaluatePixel(samples) {\n  const n_acquisitions = samples.OLCI.length;\n  const olciSamples = samples.OLCI;\n  const demSamples = samples.COP_30;\n  let r_TOA_01_valid = [];\n  let r_TOA_06_valid = [];\n  let r_TOA_17_valid = [];\n  let r_TOA_21_valid = [];\n  let snow_grain_diameter = [];\n  let snow_specific_surface_area = [];\n\n  // new products\n  let diagnostic_retrieval = [];\n  let albedo_bb_planar_sw = [];\n  let albedo_bb_spherical_sw = [];\n\n\n\n  // Loop through acquisition dates. No need to use this for single acquisition processing.\n  for (aq = 0; aq \u003c n_acquisitions; aq++) {\n    // Correct TOA reflectance for ozone absorption\n    sample_cor_o3 = ozone_correction(olciSamples[aq]);\n\n    //Transfer of OLCI relative azimuthal angle to the definition used in radiative transfer code\n    angles = view_geometry(olciSamples[aq]);\n\n    //Filtering pixels unsuitable for retrieval\n    [snow, sample_fltr] = prepare_processing(sample_cor_o3, demSamples[0]);\n\n    //Compute snow properties\n    [sample_valid, angles_valid, snow] = snow_properties(sample_fltr, angles, snow);\n\n    //Compute aerosol\n    aerosol = aerosol_properties(demSamples[0].DEM, angles_valid.cos_sa);\n\n    //Compute atmosphere\n    atmosphere = prepare_coef(aerosol, angles);\n\n    //Compute theoretical reflectance of snow from albedo\n    snow = clean_snow_albedo(sample_valid, angles, aerosol, atmosphere, snow);\n\n    //throw new Error(JSON.stringify(snow))\n\n    snow = polluted_snow_albedo(sample_valid, angles, aerosol, atmosphere, snow);\n\n    snow = compute_plane_albedo(snow, angles);\n\n    r_TOA_01_valid.push(sample_valid.B01);\n    r_TOA_06_valid.push(sample_valid.B06);\n    r_TOA_17_valid.push(sample_valid.B17);\n    r_TOA_21_valid.push(sample_valid.B21);\n    snow_grain_diameter.push(snow.diameter);\n    snow_specific_surface_area.push(snow.area);\n    diagnostic_retrieval.push(snow.isnow);\n    albedo_bb_planar_sw.push(snow.rp3);\n    albedo_bb_spherical_sw.push(snow.rs3);\n\n    // Development use. Allow you to check the output before the script is finished.\n    //throw new Error(JSON.stringify(snow))\n  }\n  return {\n    r_TOA_01: r_TOA_01_valid,\n    r_TOA_06: r_TOA_06_valid,\n    r_TOA_17: r_TOA_17_valid,\n    r_TOA_21: r_TOA_21_valid,\n    snow_grain_diameter: snow_grain_diameter,\n    snow_specific_surface_area: snow_specific_surface_area,\n    diagnostic_retrieval: diagnostic_retrieval,\n    albedo_bb_planar_sw: albedo_bb_planar_sw,\n    albedo_bb_spherical_sw: albedo_bb_spherical_sw\n  };\n}\n\nfunction deg2rad(deg) {\n  const pi = Math.PI;\n  return deg * (pi / 180);\n}\n\nfunction ozone_correction(sample) {\n  const tozone_dict = {\n    \"B01\": 1.378170469E-004,\n    \"B02\": 3.048780958E-004,\n    \"B03\": 1.645714060E-003,\n    \"B04\": 8.935947110E-003,\n    \"B05\": 1.750535146E-002,\n    \"B06\": 4.347104369E-002,\n    \"B07\": 4.487130794E-002,\n    \"B08\": 2.101591797E-002,\n    \"B09\": 1.716230955E-002,\n    \"B10\": 1.466298300E-002,\n    \"B11\": 7.983028470E-003,\n    \"B12\": 3.879744653E-003,\n    \"B13\": 2.923775641E-003,\n    \"B14\": 2.792211429E-003,\n    \"B15\": 2.729651478E-003,\n    \"B16\": 3.255969698E-003,\n    \"B17\": 8.956858078E-004,\n    \"B18\": 5.188799343E-004,\n    \"B19\": 6.715773241E-004,\n    \"B20\": 3.127781417E-004,\n    \"B21\": 1.408798425E-005\n  };\n  let toa_cor_o3 = {};\n  // Loop through OLCI bands\n  allBands.forEach(band =\u003e {\n    todadu = sample.TOTAL_COLUMN_OZONE * 46696.24;\n    inv_cos_za = 1 / Math.cos(deg2rad(sample.SZA)) + 1 / Math.cos(deg2rad(sample.VZA));\n    toa_cor_o3[band] = sample[band] * 1 * Math.exp(inv_cos_za * tozone_dict[band] * todadu / 404.59);\n  });\n\n  toa_cor_o3.SZA = sample.SZA;\n  toa_cor_o3.VZA = sample.VZA;\n  toa_cor_o3.SAA = sample.SAA;\n  toa_cor_o3.VAA = sample.VAA;\n  return toa_cor_o3;\n}\n\nfunction view_geometry(sample) {\n  const raa = 180 - (sample.VAA - sample.SAA);\n  const sin_sza = Math.sin(deg2rad(sample.SZA));\n  const sin_vza = Math.sin(deg2rad(sample.VZA));\n  const cos_sza = Math.cos(deg2rad(sample.SZA));\n  const cos_vza = Math.cos(deg2rad(sample.VZA));\n  const ak1 = 3 * (1 + 2 * cos_sza) / 7;\n  const ak2 = 3 * (1 + 2 * cos_vza) / 7;\n  const cos_raa = Math.cos(deg2rad(raa));\n  const inv_cos_za = 1 / cos_sza + 1 / cos_vza;\n  const cos_sa = -cos_sza * cos_vza + sin_sza * sin_vza * cos_raa;\n  return {\n    raa: raa,\n    cos_sza: cos_sza,\n    cos_vza: cos_vza,\n    ak1: ak1,\n    ak2: ak2,\n    inv_cos_za: inv_cos_za,\n    cos_sa: cos_sa\n  };\n}\n\nfunction prepare_processing(sample_cor, sample_dem) {\n  let snow = {};\n  let sample_fltr = {};\n\n  // Assign diagnostic code\n  snow.isnow = sample_cor.B21 \u003c 0.1 ? 102 : NaN;\n  snow.isnow = sample_cor.SZA \u003e 75 ? 100 : snow.isnow;\n  const mask = isNaN(snow.isnow);\n\n  // Loop through OLCI bands\n  allBands.forEach(band =\u003e {\n    sample_fltr[band] = (mask == true) ? sample_cor[band] : NaN;\n  });\n\n  // Add elevation info to the object\n  sample_fltr.elevation = (mask == true) ? sample_dem.DEM : NaN;\n  return [\n    snow,\n    sample_fltr\n  ];\n}\n\nfunction snow_properties(sample_fltr, angles, snow) {\n  const akap2 = 2.25e-6;\n  const alpha2 = 4 * Math.PI * akap2 / 1.020;\n  const eps = 1.549559365010611;\n  const rr1 = sample_fltr.B17;\n  const rr2 = sample_fltr.B21;\n  const ak1 = angles.ak1;\n  const ak2 = angles.ak2;\n  const r0 = Math.pow(rr1, eps) * Math.pow(rr2, (1 - eps));\n  const bal = Math.pow((Math.log(rr2 / r0) / (ak1 * ak2 / r0)), 2) / alpha2;\n  const al = bal / 1000;\n  const D = al / (9.2 * 16 / 9);\n  const area = 6 / D / 0.917;\n\n  //Filtering small D\n  const diameter_thresh = 0.01;\n  const valid = D \u003e= diameter_thresh;\n  snow.isnow = (!valid \u0026\u0026 isNaN(snow.isnow)) ? 104 : snow.isnow;\n\n  //Loop through toa bands\n  let sample_valid = {};\n\n  allBands.forEach(band =\u003e {\n    sample_valid[band] = valid ? sample_fltr[band] : NaN;\n  });\n\n  //Assign valid snow properties\n  snow.diameter = valid ? D : NaN;\n  snow.area = valid ? area : NaN;\n  snow.al = valid ? al : NaN;\n  snow.r0 = valid ? r0 : NaN;\n  snow.bal = valid ? bal : NaN;\n\n  //Loop through angles attributes\n  let angles_valid = {};\n  const angles_attrs = Object.keys(angles);\n  for (attr = 0; attr \u003c angles_attrs.length; attr++) {\n    angles_valid[angles_attrs[attr]] = valid ? angles[angles_attrs[attr]] : NaN;\n  }\n  return [\n    sample_valid,\n    angles_valid,\n    snow\n  ];\n}\n\nfunction aerosol_properties(height, cos_sa, aot = 0.1) {\n  // Set an aerosol object to store the result. \n  let aerosol = {\n    \"tau\": {},\n    \"p\": {},\n    \"g\": {},\n    \"gaer\": {},\n    \"taumol\": {},\n    \"tauaer\": {}\n  };\n\n  // Loop through OLCI bands\n  allBands.forEach(band =\u003e {\n    tauaer = aot * Math.pow((wls[band] / 0.5), -1.3);\n    g0 = 0.5263;\n    g1 = 0.4627;\n    wave0 = 0.4685;\n    gaer = g0 + g1 * Math.exp(-wls[band] / wave0);\n    pr = 0.75 * (1 + Math.pow(cos_sa, 2));\n    taumol = Math.pow(wls[band], -4.05) * Math.min(1, Math.exp(-height / 7400)) * 0.00877;\n    tau = tauaer + taumol;\n    g = tauaer * gaer / tau;\n    pa = (1 - Math.pow(g, 2)) / Math.pow((1 - 2 * g * cos_sa + Math.pow(g, 2)), 1.5);\n    p = (taumol * pr + tauaer * pa) / tau;\n\n    // Assign results to objects. Values can be called via, e.g., aerosol.tau.B01\n    Object.assign(aerosol.tau, { [band]: tau })\n    Object.assign(aerosol.p, { [band]: p })\n    Object.assign(aerosol.g, { [band]: g })\n    Object.assign(aerosol.gaer, { [band]: gaer })\n    Object.assign(aerosol.taumol, { [band]: taumol })\n    Object.assign(aerosol.tauaer, { [band]: tauaer })\n  });\n  return aerosol;\n}\n\n// Solar flux\nfunction sol(x) {\n  // SOLAR SPECTRUM at GROUND level\n  // Inputs:\n  // x - wave length in micrometer\n  // Outputs: \n  // sol - solar spectrum in W m-2 micrometer-1 (?)\n  sol1a = f0 * x;\n  sol1b = - f1 * Math.exp(-bet * x) / bet;\n  sol1c = - f2 * Math.exp(-gam * x) / gam;\n  return sol1a + sol1b + sol1c;\n}\n\nfunction analyt_func(z1, z2) {\n  // see BBA_calc_pol\n  // compatible with array\n  var gam2 = Math.exp(gam, 2);\n  var gam3 = Math.exp(gam, 3);\n\n  var z12 = Math.exp(z1, 2);\n  var z13 = Math.exp(z1, 3);\n\n  var z22 = Math.exp(z2, 2);\n  var z23 = Math.exp(z2, 3);\n\n  var bet2 = Math.exp(bet, 2);\n  var bet3 = Math.exp(bet, 3);\n\n  var ak1 = (z22 - z12) / 2.0;\n  var ak2 = (z2 / bet + 1.0 / bet2) * Math.exp(-bet * z2) - (z1 / bet + 1.0 / bet2) * Math.exp(-bet * z1);\n  var ak3 = (z2 / gam + 1.0 / gam2) * Math.exp(-gam * z2) - (z1 / gam + 1.0 / gam2) * Math.exp(-gam * z1);\n  var am_minus = (z12 / bet + 2.0 * z1 / bet2 + 2.0 / bet3) * Math.exp(-bet * z1);\n\n  var am1 = (z23 - z13) / 3.0;\n  var am2 = (z22 / bet + 2.0 * z2 / bet2 + 2.0 / bet3) * Math.exp(-bet * z2) - am_minus\n  var am3 = (z22 / gam + 2.0 * z2 / gam2 + 2.0 / gam3) * Math.exp(-gam * z2) - am_minus;\n\n  return (f0 * ak1 - f1 * ak2 - f2 * ak3), (f0 * am1 - f1 * am2 - f2 * am3);\n}\n\nfunction prepare_coef(aerosol, angles) {\n  // Set an atmosphere object \n  let atmosphere = {\n    \"t1\": {},\n    \"t2\": {},\n    \"ratm\": {},\n    \"r\": {}\n  };\n\n  // Loop through OLCI bands\n  allBands.forEach(band =\u003e {\n    tau = aerosol.tau[band];\n    g = aerosol.g[band];\n    p = aerosol.p[band];\n    cos_sza = angles.cos_sza;\n    cos_vza = angles.cos_vza;\n    inv_cos_za = angles.inv_cos_za;\n\n    one_g_tau = (1 - g) * tau;\n\n    b1 = 1 + 1.5 * cos_sza + (1 - 1.5 * cos_sza) * Math.exp(-tau / cos_sza);\n    b2 = 1 + 1.5 * cos_vza + (1 - 1.5 * cos_vza) * Math.exp(-tau / cos_vza);\n\n    sumcos = cos_sza + cos_vza;\n\n    astra = (1 - Math.exp(-tau * inv_cos_za)) / sumcos / 4;\n    oskar = 4 + 3 * one_g_tau;\n\n    rms = 1 - b1 * b2 / oskar + (3 * (1 + g) * (cos_sza * cos_vza) - 2 * sumcos) * astra;\n\n    r = p * astra + rms;\n\n    wa1 = 1.10363;\n    wa2 = -6.70122;\n    wx0 = 2.19777;\n    wdx = 0.51656;\n    bex = Math.exp((g - wx0) / wdx);\n\n    arg = -0.5 * one_g_tau / ((wa1 - wa2) / (1 + bex) + wa2);\n\n    t1 = Math.exp(arg / cos_sza);\n    t2 = Math.exp(arg / cos_vza);\n\n    a_s = [.18016, -0.18229, 0.15535, -0.14223];\n    bs = [.58331, -0.50662, -0.09012, 0.0207];\n    cs = [0.21475, -0.1, 0.13639, -0.21948];\n    als = [0.16775, -0.06969, 0.08093, -0.08903];\n    bets = [1.09188, 0.08994, 0.49647, -0.75218];\n\n    a_cst = a_s[0] + a_s[1] * g;\n    b_cst = bs[0] + bs[1] * g;\n    c_cst = cs[0] + cs[1] * g;\n    al_cst = als[0] + als[1] * g;\n    bet_cst = bets[0] + bets[1] * g;\n\n    for (num = 2; num \u003c 4; num++) {\n      if (num == 2) {\n        gg = Math.pow(g, 2);\n      } else {\n        gg *= g;\n      }\n      a_cst += a_s[num] * gg\n      b_cst += bs[num] * gg\n      c_cst += cs[num] * gg\n      al_cst += als[num] * gg\n      bet_cst += bets[num] * gg\n    }\n    ratm = tau * (a_cst * Math.exp(-tau / al_cst) + b_cst * Math.exp(-tau / bet_cst) + c_cst)\n\n    // Assign the results to the objects\n    Object.assign(atmosphere.t1, { [band]: t1 });\n    Object.assign(atmosphere.t2, { [band]: t2 });\n    Object.assign(atmosphere.ratm, { [band]: ratm });\n    Object.assign(atmosphere.r, { [band]: r });\n  });\n\n  return atmosphere;\n}\n\nfunction alb2rtoa(a, t1, t2, r0, ak1, ak2, ratm, r) {\n  const surf = t1 * t2 * r0 * Math.pow(a, (ak1 * ak2 / r0)) / (1 - a * ratm);\n  const rs = r + surf;\n  return rs;\n}\n\nfunction clean_snow_albedo(sample_valid, angles, aerosol, atmosphere, snow) {\n  snow.rs_1 = alb2rtoa(1, atmosphere.t1.B01, atmosphere.t2.B01, 1, 1, 1, atmosphere.ratm.B01, atmosphere.r.B01);\n  snow.ind_clean = sample_valid.B01 \u003e= snow.rs_1;\n  snow.isnow = (snow.ind_clean) ? 0 : snow.isnow;\n  snow.ind_pol = sample_valid.B01 \u003c snow.rs_1;\n\n  var alb_sph = Object.assign({}, emptyBandObject);\n  allBands.forEach(band =\u003e {\n    alb_sph[band] = Math.min(Math.exp(-Math.sqrt(1000 * 4 * Math.PI * (bai[band] / wls[band] * snow.al))), 1);\n  });\n\n  // Assign the results to the objects\n  snow.alb_sph = alb_sph;\n  return snow;\n}\n\nfunction polluted_snow_albedo(sample_valid, angles, aerosol, atmosphere, snow) {\n  //throw new Error(JSON.stringify(sample_valid));\n\n  if (snow.ind_pol) {\n    snow.isnow = (snow.ind_pol) ? 1 : snow.isnow;\n    ind_very_dark = (sample_valid.B21 \u003c 0.4 \u0026\u0026 snow.ind_pol);\n    snow.isnow = (ind_very_dark) ? 6 : snow.isnow;\n    snow.r0 = (!ind_very_dark) ? snow.isnow : compute_rclean(angles.cos_sza, angles.cos_vza, angles.cos_sa, angles.raa);\n    //snow.alb_sph = (snow.ind_pol) ? 1 : snow.alb_sph; Guess it applies to all bands\n    Object.keys(snow.alb_sph).forEach(band =\u003e {\n      snow.alb_sph[band] = (snow.ind_pol) ? 1 : snow.alb_sph[band]\n    })\n\n    const bands_to_loop_over = Object.keys(sample_valid);\n    bands_to_loop_over.splice(18, 2);\n\n    //throw new Error(JSON.stringify(bands_to_loop_over));\n\n    for (i = 0; i \u003c bands_to_loop_over.length; i++) {\n      var band = bands_to_loop_over[i];\n      snow.alb_sph[band] = (snow.ind_pol) ? solver_wrapper(sample_valid[band], atmosphere.t1[band], atmosphere.t2[band], snow.r0, angles.ak1, angles.ak2, atmosphere.ratm[band], atmosphere.r[band]) : snow.alb_sph[band];\n      snow.isnow = snow.alb_sph[band] == -999 ? -(i + 1) : snow.isnow;\n    }\n\n    // Guess it applies to all bands\n    Object.keys(snow.alb_sph).forEach(band =\u003e {\n      snow.alb_sph[band] = snow.isnow ? snow.alb_sph[band] : NaN;\n    })\n\n    let ind_clear_pol = (snow.alb_sph.B01 \u003e 0.98 | snow.alb_sph.B02 \u003e 0.98) \u0026 snow.ind_pol;\n    snow.isnow = ind_clear_pol ? 7 : snow.isnow;\n\n    // Guess it applies to all bands\n    if (!ind_clear_pol) {\n      allBands.forEach(band =\u003e {\n        snow.alb_sph[band] = Math.exp(-Math.sqrt(4 * 1000 * Math.PI * snow.al * (bai[band] / wls[band])));\n      });\n    }\n\n    snow.ind_pol = snow.ind_pol \u0026 (snow.isnow != 7);\n\n    // reprocessing of albedo to remove gaseous absorption using linear polynomial approximation in the range 753-778nm.\n    // Meaning: alb_sph[12],alb_sph[13] and alb_sph[14] are replaced by a linear  interpolation between alb_sph[11] and alb_sph[15]\n    if (ind_clear_pol) {\n      afirn = snow.alb_sph['B15'] - snow.alb_sph['B11'] / (wls['B15'] - wls['B11']);\n      bfirn = snow.alb_sph['B15'] - afirn * wls['B15'];\n\n      // indeces of bands start with 0!\n      allBands.concat().splice(11, 3).forEach(band =\u003e {\n        snow.alb_sph[band] = bfirn + afirn * wls[band];\n      });\n    }\n\n    // pixels that are clean enough in channels 18 19 20 and 21 are not affected by pollution, the analytical equation can then be used\n    ind_ok = (sample_valid.B20 \u003e 0.35) \u0026 snow.ind_pol;\n    if (ind_ok) {\n      allBands.concat().splice(17, 4).forEach(band =\u003e {\n        snow.alb_sph[band] = Math.exp(-Math.sqrt(4. * 1000. * Math.PI * snow.al * (bai[band] / wls[band])));\n      });\n    }\n\n    //to avoid the influence of gaseous absorption (water vapor) we linearly interpolate in the range 885-1020nm for bare ice cases only (low toa[20])\n    //Meaning: alb_sph[18] and alb_sph[19] are replaced by a linear interpolation between alb_sph[17] and alb_sph[20]\n    if (ind_ok) {\n      bcoef = (snow.alb_sph['B20'] - snow.alb_sph['B17']) / (wls['B20'] - wls['17'])\n      acoef = snow.alb_sph['B20'] - bcoef * wls['B20']\n      allBands.concat().splice(17, 2).forEach(band =\u003e {\n        snow.alb_sph[band] = acoef + bcoef * wls[band];\n      });\n    }\n  }\n  return snow;\n}\n\nfunction compute_plane_albedo(snow, angles) {\n  var rp = Object.assign({}, emptyBandObject);\n  var refl = Object.assign({}, emptyBandObject);\n\n  snow.rp = rp;\n  snow.refl = refl;\n\n  allBands.forEach(band =\u003e {\n    snow.rp[band] = Math.pow(snow.alb_sph[band], angles.ak1);\n    snow.refl[band] = snow.r0[band] * Math.pow(snow.alb_sph[band], angles.ak1 * angles.ak2 / snow.r0);\n  });\n\n  ind_all_clean = snow.ind_clean || (snow.isnow == 7);\n\n\n  if (ind_all_clean) {\n    snow.rp3 = plane_albedo_sw_approx(snow.diameter, angles.cos_sza);\n    snow.rs3 = spher_albedo_sw_approx(snow.diameter);\n  }\n\n  // solar flux calculation\n  // sol1      visible(0.3 - 0.7micron)\n  // somehow, a different sol1 needs to be used for clean snow and polluted snow\n  var sol1_pol = sol(0.7) - sol(0.3);\n  // sol2      near - infrared(0.7 - 2.4micron)\n  // same for clean and polluted\n  var sol2 = sol(2.4) - sol(0.7);\n\n  // sol3      shortwave(0.3 - 2.4 micron)\n  // sol3 is also different for clean snow and polluted snow\n  var sol3_pol = sol1_pol + sol2;\n\n  // asol specific band\n  var asol = sol(0.865) - sol(0.7);\n\n  if (snow.ind_pol) {\n    snow.rp3 = BBA_calc_pol(snow.rp, asol, sol1_pol, sol3_pol);\n    snow.rs3 = BBA_calc_pol(snow.alb_sph, asol, sol1_pol, sol3_pol);\n  }\n\n  return snow;\n}\n\nfunction BBA_calc_pol(alb, asol, sol1_pol, sol3_pol) {\n  // polluted snow\n  // NEW CODE FOR BBA OF BARE ICE\n  // alb is either the planar or spherical albedo\n\n  // ANAlYTICal EQUATION FOR THE NOMINATOR\n  // integration over 3 segments\n\n  // segment 1\n  // QUADRATIC POLYNOMIal for the range 400 - 709nm\n  // input wavelength\n  //    alam2 = w[0]\n  //    alam3 = w[5]\n  //    alam5 = w[10]\n  //    alam6 = w[11]\n  //    alam7 = w[16]\n  //    alam8 = w[20]\n\n  const alam2 = 0.4;\n  const alam3 = 0.56;\n  const alam5 = 0.709;\n  const alam6 = 0.753;\n  const alam7 = 0.865;\n  const alam8 = 1.02;\n\n  // input reflectances\n  var r2 = alb['B01'];\n  var r3 = alb['B05'];\n  var r5 = alb['B10'];\n  var r6 = alb['B011'];\n  var r7 = alb['B16'];\n  var r8 = alb['B20'];\n\n  // declared outside\n  //var coef1, coef2 = analyt_func(0.3, 0.7);\n  //var coef3, coef4 = analyt_func(0.7, 0.865);\n\n  var a1, b1, c1 = quad_func(alam2, alam3, alam5, r2, r3, r5)\n  var aj1 = a1 * sol1_pol + b1 * coef1 + c1 * coef2;\n\n  // segment 2.1\n  // QUADRATIC POLYNOMIal for the range 709 - 865nm\n  var a2, b2, c2 = quad_func(alam5, alam6, alam7, r5, r6, r7)\n  var aj2 = a2 * asol + b2 * coef3 + c2 * coef4;    // segment 2.2\n\n  // exponential approximation for the range 865 - 2400 nm\n  const z1 = 0.865;\n  const z2 = 2.4;\n  var rati = r7 / r8;\n  var alasta = (alam8 - alam7) / Math.log(rati);\n  var an = 1. / alasta;\n  var p = r7 * Math.exp(alam7 / alasta);\n\n  var aj31 = (1. / an) * (Math.exp(-an * z2) - Math.exp(-an * z1));\n  var aj32 = (1. / (bet + an)) * (Math.exp(-(bet + an) * z2) - Math.exp(-(an + bet) * z1));\n  var aj33 = (1. / (gam + an)) * (Math.exp(-(gam + an) * z2) - Math.exp(-(an + gam) * z1));\n  var aj3 = (-f0 * aj31 - f1 * aj32 - f2 * aj33) * p;\n\n  return (aj1 + aj2 + aj3) / sol3_pol;\n}\n\nfunction quad_func(x0, x1, x2, y0, y1, y2) {\n  // quadratic function used for the polluted snow BBA calculation\n  // see BBA_calc_pol\n  // compatible with arrays\n  var d1 = (x0 - x1) * (x0 - x2);\n  var d2 = (x1 - x0) * (x1 - x2);\n  var d3 = (x2 - x0) * (x2 - x1);\n\n  var a1 = x1 * x2 * y0 / d1 + x0 * x2 * y1 / d2 + x0 * x1 * y2 / d3;\n  var b1 = -(x1 + x2) * y0 / d1 - (x0 + x2) * y1 / d2 - (x0 + x1) * y2 / d3;\n  var c1 = y0 / d1 + y1 / d2 + y2 / d3;\n  var x = x1;\n  return a1, b1, c1;\n}\n\nfunction spher_albedo_sw_approx(D) {\n  return 0.6420 + 0.1044 * Math.exp(-1000 * D / 158.62) + 0.1773 * Math.exp(-1000 * D / 2448.18);\n}\n\nfunction plane_albedo_sw_approx(D, cos_sza) {\n  var cos_sza2 = Math.exp(cos_sza, 2);\n  var anka = 0.7389 - 0.1783 * cos_sza + 0.0484 * cos_sza2;\n  var banka = 0.0853 + 0.0414 * cos_sza - 0.0127 * cos_sza2\n  var canka = 0.1384 + 0.0762 * cos_sza - 0.0268 * cos_sza2;\n  var diam1 = 187.89 - 69.2636 * cos_sza + 40.4821 * cos_sza2;\n  var diam2 = 2687.25 - 405.09 * cos_sza + 94.5 * cos_sza2;\n  return anka + banka * Math.exp(-1000 * D / diam1) + canka * Math.exp(-1000 * D / diam2)\n}\n\nfunction compute_rclean(cos_sza, cos_vza, cos_sa, raa) {\n  const am11 = Math.sqrt(1 - Math.pow(cos_sza, 2));\n  const am12 = Math.sqrt(1 - Math.pow(cos_vza, 2));\n  const theta = Math.acos(-cos_sza * cos_vza + am11 * am12 * Math.cos(raa * 3.14159 / 180)) * 180 / Math.PI;\n  const pz = 11.1 * Math.exp(-0.087 * theta) + 1.1 * Math.exp(-0.014 * theta);\n  const sumcos = cos_sza + cos_vza;\n  const rclean = 1.247 + 1.186 * sumcos + 5.157 * cos_sza * cos_vza + pz;\n  return rclean / 4 / sumcos;\n}\n\nfunction solver_wrapper(toa_cor_o3, t1, t2, r0, ak1, ak2, ratm, r) {\n  return zbrent(0.1, 1, args = [t1, t2, r0, ak1, ak2, ratm, r, toa_cor_o3], max_iter = 30, tolerance = 2e-4);\n}\n\nfunction zbrent(x0, x1, args, max_iter = 100, tolerance = 1e-6) {\n  let fx0 = f(x0, ...args = args);\n  let fx1 = f(x1, ...args = args);\n  if ((fx0 * fx1) \u003e 0) {\n    return -999;\n  }\n  if (Math.abs(fx0) \u003c Math.abs(fx1)) {\n    [x0, x1] = [x1, x0];\n    [fx0, fx1] = [fx1, fx0];\n  }\n  let [x2, fx2] = [x0, fx0];\n  let d = x2;\n  let mflag = true;\n  let steps_taken = 0;\n  while (steps_taken \u003c max_iter \u0026\u0026 Math.abs(x1 - x0) \u003e tolerance) {\n    fx0 = f(x0, ...args = args);\n    fx1 = f(x1, ...args = args);\n    fx2 = f(x2, ...args = args);\n\n    if (fx0 != fx2 \u0026\u0026 fx1 != fx2) {\n      let L0 = (x0 * fx1 * fx2) / ((fx0 - fx1) * (fx0 - fx2));\n      let L1 = (x1 * fx0 * fx2) / ((fx1 - fx0) * (fx1 - fx2));\n      let L2 = (x2 * fx1 * fx0) / ((fx2 - fx0) * (fx2 - fx1));\n      var new_value = L0 + L1 + L2;\n    } else {\n      var new_value = x1 - ((fx1 * (x1 - x0)) / (fx1 - fx0));\n    }\n\n    if (\n      (new_value \u003c ((3 * x0 + x1) / 4) || new_value \u003e x1) ||\n      (mflag == true \u0026\u0026 (Math.abs(new_value - x1)) \u003e= (Math.abs(x1 - x2) / 2)) ||\n      (mflag == false \u0026\u0026 (Math.abs(new_value - x1)) \u003e= (Math.abs(x2 - d) / 2)) ||\n      (mflag == true \u0026\u0026 (Math.abs(x1 - x2)) \u003c tolerance) ||\n      (mflag == false \u0026\u0026 (Math.abs(x2 - d)) \u003c tolerance)\n    ) {\n      new_value = (x0 + x1) / 2;\n      mflag = true;\n    } else {\n      mflag = false;\n    }\n\n    let fnew = f(new_value, ...args = args);\n    [d, x2] = [x2, x1];\n\n    if (fx0 * fnew \u003c 0) {\n      x1 = new_value;\n    } else {\n      x0 = new_value;\n    }\n\n    if (Math.abs(fx0) \u003c Math.abs(fx1)) {\n      [x0, x1] = [x1, x0];\n    }\n\n    steps_taken += 1;\n  }\n  return x1;\n}\n\n// not used?\nfunction f(albedo, t1, t2, r0, ak1, ak2, ratm, r, toa_cor_o3) {\n  const surf = t1 * t2 * r0 * albedo ** (ak1 * ak2 / r0) / (1 - albedo * ratm);\n  const rs = r + surf\n  return toa_cor_o3 - rs;\n}\n\"\"\"\n\nlogging.info(\"Configuration ok.\")    ","visibility":"show","key":"wzyFy7DAN7"},{"type":"outputs","id":"AmDGg7BOSr4VLkSeEuQMP","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:11 [INFO] root - Configuration ok.\n"},"children":[],"key":"nVY3PQc2qP"}],"visibility":"show","key":"Iy9C6YgokF"}],"visibility":"show","key":"PhaPPrF8hO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"date_range = (f'{date}T8:00:00', f'{date}T18:00:00')\n\nDATE_FOLDER = date.replace(\"-\",\"_\")\nDL_FOLDER =  os.path.join('downloads', str(resolution), DATE_FOLDER)\nPROCESSED_FOLDER = f'{DL_FOLDER}/processed'\n\nDATE_FOLDER","key":"yvY7c246KA"},{"type":"outputs","id":"CqAupYhsOfcxb7KJuu0_A","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":8,"metadata":{},"data":{"text/plain":{"content":"'2021_07_09'","content_type":"text/plain"}}},"children":[],"key":"MU2kD3D1sq"}],"key":"kzHq5EStKS"}],"key":"Am6TPMDBW7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"aoi_gpd = gpd.GeoDataFrame(geometry=[wkt.loads(aoi)], crs = \"EPSG:4326\")","key":"O0bUxgJcuM"},{"type":"outputs","id":"ncA6hsVbfSiMDahozbliJ","children":[],"key":"jn9OUm9PM3"}],"key":"XjxblpeoKN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# load the 1 degree world grid from which the tiles will be calculated\nlogging.info(\"Loading grid\")\ngrid = gpd.read_file(os.environ[\"DATA_PATH\"] + \"/wgs84-1degree.geojson\")","key":"yb3RN7wnst"},{"type":"outputs","id":"T5Za5L9updUDNaBCTXRnq","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:35 [INFO] root - Loading grid\n"},"children":[],"key":"FGfHS6MECr"}],"key":"epNmSKHNVT"}],"key":"H3k7ruJ1Jr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"logging.info(\"Calculating tiles to be processed.\")    \n\n# make the intersection with the polygon so that we only calculate tiles inside the polygon\ntoProcess=gpd.overlay(aoi_gpd, grid, how='intersection')\n\n#Remove chunks that are too small to be processed\nMIN_AREA = 1e-1\ntoProcess = toProcess[toProcess.geometry.to_crs('epsg:4326').area \u003e MIN_AREA]","key":"SPUCz2Gnel"},{"type":"outputs","id":"V7G9tGVCns6ovaGc-ukzn","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:39 [INFO] root - Calculating tiles to be processed.\n/tmp/ipykernel_386/667727171.py:8: UserWarning: Geometry is in a geographic CRS. Results from 'area' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.\n\n  toProcess = toProcess[toProcess.geometry.to_crs('epsg:4326').area \u003e MIN_AREA]\n"},"children":[],"key":"hLAO9dlRP5"}],"key":"Y1mLG3qGJw"}],"key":"HP3OwmacWa"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# use full frames\ntoProcess = grid[grid.ID.isin(list(toProcess.ID.values))]","key":"SLA8OLfXam"},{"type":"outputs","id":"PxWvwpB6gZPURdjWPZ4zG","children":[],"key":"GvxrHdPq3a"}],"key":"d2rwMkCWvX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"if DELETE_DOWNLOAD_FOLDER and os.path.exists(DL_FOLDER):\n    shutil.rmtree(DL_FOLDER)\n    logging.info(f'Folder {DL_FOLDER} deleted')","key":"ghXfUkSBge"},{"type":"outputs","id":"SrDkJsXL0tDjhpUrROz1w","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:46 [INFO] root - Folder downloads/1200/2021_07_09 deleted\n"},"children":[],"key":"BekdfYdsTO"}],"key":"kYoH8WrvlT"}],"key":"bKvXW0vCyB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"listBbox = [BBox(bbox=geom, crs=\"EPSG:4326\") for geom in toProcess.geometry]\nlistSizes = [bbox_to_dimensions(bbox, resolution=resolution) for bbox in listBbox]\nfolderPaths = [f'{DL_FOLDER}/{round(id)}' for id in toProcess.ID]","key":"izLORP0y65"},{"type":"outputs","id":"inLM3KYcBaHPsHy57wT-O","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"/home/88c8cc07-d79c-45b9-a407-ba18967711b0/.local/lib/python3.9/site-packages/sentinelhub/geometry.py:113: SHDeprecationWarning: Initializing `BBox` objects from `shapely` geometries will no longer be possible in future versions. Use the `bounds` property of the `shapely` geometry to initialize the `BBox` instead.\n  x_fst, y_fst, x_snd, y_snd = BBox._to_tuple(bbox)\n"},"children":[],"key":"wL3u5k1A64"}],"key":"QLKopx4Mnj"}],"key":"MPMrV333GS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"requests = [SentinelHubRequest(\n            evalscript=evalscript,\n            data_folder=folderPath,\n            input_data=[\n                SentinelHubRequest.input_data(\n                    data_collection=DataCollection.DEM_COPERNICUS_30,\n                    identifier=\"COP_30\",\n                    upsampling=\"NEAREST\",\n                    downsampling=\"NEAREST\",\n                ),\n                SentinelHubRequest.input_data(\n                    data_collection=DataCollection.SENTINEL3_OLCI,\n                    identifier=\"OLCI\",\n                    time_interval=date_range,\n                    upsampling=\"NEAREST\",\n                    downsampling=\"NEAREST\",\n                ),\n            ],\n            responses=[\n                SentinelHubRequest.output_response('r_TOA_01', MimeType.TIFF),\n                SentinelHubRequest.output_response('r_TOA_06', MimeType.TIFF),\n                SentinelHubRequest.output_response('r_TOA_17', MimeType.TIFF),\n                SentinelHubRequest.output_response('r_TOA_21', MimeType.TIFF),\n                SentinelHubRequest.output_response('snow_grain_diameter', MimeType.TIFF),\n                SentinelHubRequest.output_response('snow_specific_surface_area', MimeType.TIFF),\n                SentinelHubRequest.output_response('diagnostic_retrieval', MimeType.TIFF),\n                SentinelHubRequest.output_response('albedo_bb_planar_sw', MimeType.TIFF),\n                SentinelHubRequest.output_response('albedo_bb_spherical_sw', MimeType.TIFF),\n            ],\n            bbox=bb,\n            size=size,\n            config=sh_config\n        ) for bb, size, folderPath in zip(listBbox, listSizes, folderPaths)]\n\n#extract only downloader\nlist_of_requests = [request.download_list[0] for request in requests]","key":"UgCJ949VOU"},{"type":"outputs","id":"qcOfOrA-n_MomXbGTC5M5","children":[],"key":"YOTgVhTIVV"}],"key":"OjgAbNhUbO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"logging.info('Starting download')\ndownloader = SentinelHubDownloadClient(config=sh_config)\ndownloader.download(list_of_requests, max_threads=20, show_progress=False)\nlogging.info('Done')","key":"yEbrzGHARw"},{"type":"outputs","id":"AUu7lKHpo2zKTAQkuf3bc","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:46 [INFO] root - Starting download\n2023-03-07 14:49:50 [INFO] root - Done\n"},"children":[],"key":"FuiEocwHqW"}],"key":"vH6FEFTJMT"}],"key":"kdg1JDkK1l"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def unzipFile(file, destination):\n    if not os.path.exists(os.path.join(destination, 'snow_grain_diameter.tif')):\n        tar = tarfile.open(file, \"r:\")\n        tar.extractall(path=destination)\n        tar.close()","key":"XUH6CEXes8"},{"type":"outputs","id":"-gPfO5bTO08HppBHRHUde","children":[],"key":"nYwUax0w3c"}],"key":"zlHdwwJx1H"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"class ConcurrentUnzipper:\n    def __init__(self, files, destinations):\n        self.files = files\n        self.destinations = destinations\n        \n    def operation(self, chunk):\n        unzipFile(self.files[chunk] , self.destinations[chunk])\n        \n    def unzipAll(self):\n        with concurrent.futures.ProcessPoolExecutor() as executor:\n            list(executor.map(self.operation, np.arange(0, len(self.files)), chunksize=1))","key":"XgYjyY9yV9"},{"type":"outputs","id":"AwXO-S3opBm2egCnd5qk2","children":[],"key":"tMNOkkeYYM"}],"key":"Of5Rf3rYaR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filenamesList = glob.glob(f'./{DL_FOLDER}/*/*/response.tar')\ndestinations =  [file.replace('response.tar', '') for file in filenamesList]        \n        \nlogging.info('Extracting .tar responses')\nunzipper = ConcurrentUnzipper(filenamesList, destinations)\nunzipper.unzipAll()\nlogging.info('Done')","key":"AfDC7NYhUw"},{"type":"outputs","id":"3obrfyVuKsa2DzSxyeeT7","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:50 [INFO] root - Extracting .tar responses\n2023-03-07 14:49:50 [INFO] root - Done\n"},"children":[],"key":"ZfRUSJEnHW"}],"key":"PTKYabRKvt"}],"key":"PK6D9UTrBX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def mergeProduct(productName):\n    prodResult = productName.replace(\".tif\", '_merged.tif')\n    if os.path.exists(prodResult):\n        os.remove(prodResult)\n        logging.info(f'Deleted file: {prodResult}')\n    filenamesList = glob.glob(f'./{DL_FOLDER}/*/*/{productName}')\n    merge_tiffs(filenamesList, prodResult, overwrite=True)\n     \nclass TifMerger:\n    def __init__(self, products):\n        self.products = products\n        \n    def operation(self, chunk):\n        mergeProduct(self.products[chunk])\n        \n    def process(self):\n        with concurrent.futures.ProcessPoolExecutor() as executor:\n            list(executor.map(self.operation, np.arange(0, len(self.products)), chunksize=1))    ","key":"MrhGkNOQeX"},{"type":"outputs","id":"2kU4RmkJsrWtXpZjIke7C","children":[],"key":"gpZeLGJC8Q"}],"key":"zB0FtGQBXQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#define the products that will be computed\nproducts = ['diagnostic_retrieval.tif','albedo_bb_planar_sw.tif','albedo_bb_spherical_sw.tif','snow_grain_diameter.tif', 'snow_specific_surface_area.tif', 'r_TOA_01.tif', 'r_TOA_06.tif', 'r_TOA_17.tif', 'r_TOA_21.tif']\n#products = ['snow_grain_diameter.tif']\n\n#merge individual tiles into one single image\nlogging.info('Merging products')\nunzipper = TifMerger(products)\nunzipper.process()\nlogging.info('Done')    \n\nresultsDataPath = os.path.join(USR_PATH, PROCESSED_FOLDER)","key":"vfvJ28inUS"},{"type":"outputs","id":"_gF8xK5jHqVUvw8X6TMA6","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:50 [INFO] root - Merging products\n2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to albedo_bb_planar_sw_merged.tif\n2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to r_TOA_17_merged.tif\n2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to diagnostic_retrieval_merged.tif\n2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to r_TOA_06_merged.tif\n2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to albedo_bb_spherical_sw_merged.tif\n2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to snow_specific_surface_area_merged.tif\n2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to snow_grain_diameter_merged.tif\n2023-03-07 14:49:50 [INFO] root - merging 4 tiffs to r_TOA_01_merged.tif\n"},"children":[],"key":"utU9cSh5Wf"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"00000000"},"children":[],"key":"rotvSQ8m0K"},{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:52 [INFO] root - merging done\n2023-03-07 14:49:52 [INFO] root - merging 4 tiffs to r_TOA_21_merged.tif\n2023-03-07 14:49:52 [INFO] root - merging done\n2023-03-07 14:49:52 [INFO] root - merging done\n"},"children":[],"key":"ErePv6AcfB"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"...10...20.....10...20...30...40...50...60...70.....10...20.....10...20...30...40...50...10...20.....60...70.....10...20.....10...20...80...90...100 - done.\n...10...20...30...40...50.30...40...50...60...70.....60...70...30...40...50...60...70...80...90...100 - done.\n.30...40...50.30...40...50...60...70.....60...70...30...40...50...60...70...80...90...100 - done.\n.80...90...100 - done.\n.80...90...100 - done.\n.80...90...100 - done.\n.80...90...100 - done.\n.80...90...100 - done.\n"},"children":[],"key":"ar5iS2heda"},{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:52 [INFO] root - merging done\n2023-03-07 14:49:52 [INFO] root - merging done\n2023-03-07 14:49:52 [INFO] root - merging done\n2023-03-07 14:49:52 [INFO] root - merging done\n2023-03-07 14:49:52 [INFO] root - merging done\n"},"children":[],"key":"WsNCE9crJu"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"0"},"children":[],"key":"vIC6cqyIWm"},{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2023-03-07 14:49:52 [INFO] root - merging done\n2023-03-07 14:49:52 [INFO] root - Done\n"},"children":[],"key":"Y9qdU5qug5"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"...10...20...30...40...50...60...70...80...90...100 - done.\n"},"children":[],"key":"K8YeUvaa0G"}],"key":"tAtHM3eswD"}],"key":"t5p4CtwK3e"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"if not os.path.exists(PROCESSED_FOLDER):\n    os.makedirs(PROCESSED_FOLDER)\n    \nproducedFiles = glob.glob('*_merged.tif')\nfor prodResult in producedFiles:\n    shutil.move(prodResult, f'{PROCESSED_FOLDER}/{prodResult}')\n    \nresultsDataPath = os.path.join(USR_PATH, PROCESSED_FOLDER)\nresultsDataPath","key":"kcgx036pzz"},{"type":"outputs","id":"zJcqcItyGP_PpbHYLTban","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":24,"metadata":{},"data":{"text/plain":{"content":"'/home/88c8cc07-d79c-45b9-a407-ba18967711b0/downloads/1200/2021_07_09/processed'","content_type":"text/plain"}}},"children":[],"key":"z5L4Nf6ELQ"}],"key":"L6kcpIYgcc"}],"key":"ajV1N7ZNqr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"processedDataPath = os.path.join(USR_PATH, PROCESSED_FOLDER)\nif len(projection) \u003e 0 and not projection == '4326' : \n    destFolder = f'{DL_FOLDER}/warped/'\n\n    logging.info('Reprojecting to epsg:{projection}')\n    \n    if os.path.exists(destFolder):\n        shutil.rmtree(destFolder)\n\n    os.makedirs(destFolder)\n\n    for product in products:\n        srcFile = processedDataPath + \"/\" + product.replace(\".tif\", \"_merged.tif\")\n        destFile = f'{destFolder}/{product}'\n        cmd = f'gdalwarp {srcFile} {destFile}  -t_srs EPSG:{projection}'\n        os.system(cmd)\n   \n    resultsDataPath = destFolder\nelse:\n    for product in products:\n        srcFile = processedDataPath + \"/\" + product.replace(\".tif\", \"_merged.tif\")\n        destFile = processedDataPath + \"/\" + product\n        if os.path.exists(srcFile):\n            os.rename(srcFile, destFile)","key":"iKmSheY7tq"},{"type":"outputs","id":"t4l3IkEp0teR9lme65I5q","children":[],"key":"SpaB391M6m"}],"key":"KCTFsJCfK8"}],"key":"hZbwSWYFw0"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Ccadi U C3","url":"/notebooks/ccadi-uc3","group":"Notebooks"},"next":{"title":"PolarTEP eScience Lab:  Using XCube in Polar-TEP to Generate NDVI","url":"/notebooks/xcube-tutorial","group":"Notebooks"}}},"domain":"http://localhost:3000"},"project":{"subject":"Notebook examples","title":"PolarTEP Notebooks","description":"Collection of examples relevant to the PolarTEP","github":"https://github.com/gtif-cerulean/polartep_notebooks","id":"5aa0318b-5bc1-41e2-b1d4-053e8b61961b","exports":[],"bibliography":[],"index":"readme","pages":[{"title":"Notebooks","level":1},{"slug":"notebooks.ccadi-uc3","title":"Ccadi U C3","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.sice","title":"Sentinel-3 Snow and ICE products (SICE)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.xcube-tutorial","title":"PolarTEP eScience Lab:  Using XCube in Polar-TEP to Generate NDVI","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}}},"actionData":null,"errors":null},"future":{"unstable_dev":false,"unstable_postcss":false,"unstable_tailwind":false,"v2_errorBoundary":true,"v2_headers":true,"v2_meta":true,"v2_normalizeFormMethod":true,"v2_routeConvention":true}};</script><script type="module" async="">import "/polartep_notebooks/build/manifest-3595279D.js";
import * as route0 from "/polartep_notebooks/build/root-SIO6LUTY.js";
import * as route1 from "/polartep_notebooks/build/routes/$-PRP77N34.js";
window.__remixRouteModules = {"root":route0,"routes/$":route1};

import("/polartep_notebooks/build/entry.client-PCJPW7TK.js");</script></body></html>