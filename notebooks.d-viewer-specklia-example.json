{"version":3,"kind":"Notebook","sha256":"e69e2c0bd0a28ad3fe0a24ab4c730047962ae445d1242fdd5bf80beb56ace90c","slug":"notebooks.d-viewer-specklia-example","location":"/notebooks/4d_viewer_specklia_example.ipynb","dependencies":[],"frontmatter":{"title":"Important! You must generate a Specklia access key before running this workbook","content_includes_title":false,"kernelspec":{"name":"conda-env-mamba-xc-4d-py","display_name":"mamba-xc-4d","language":"python"},"github":"https://github.com/gtif-cerulean/polartep_notebooks","subject":"Notebook examples","numbering":{"title":{"offset":1}},"source_url":"https://github.com/gtif-cerulean/polartep_notebooks/blob/main/notebooks/4d_viewer_specklia_example.ipynb","edit_url":"https://github.com/gtif-cerulean/polartep_notebooks/edit/main/notebooks/4d_viewer_specklia_example.ipynb","exports":[{"format":"ipynb","filename":"4d_viewer_specklia_example.ipynb","url":"/polartep_notebooks/build/4d_viewer_specklia_e-ca7f307fcdd6b4b1a8410407c86151f0.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"This example accesses Earthwave’s Specklia point data service. This does not require user registration but it does require that each user generates an API access token via:\n","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"t3Jir8ovIK"},{"type":"link","url":"https://specklia.earthwave.co.uk/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"https://​specklia​.earthwave​.co​.uk/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hU0h8Pl61h"}],"urlSource":"https://specklia.earthwave.co.uk/","key":"mxQL1DMYzU"}],"key":"t5tJmBBiC4"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"More information on the Specklia platform can be found in the documentation here: ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"UhCrBHsy91"},{"type":"link","url":"https://specklia.earthwave.co.uk/static/docs/index.html","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"https://​specklia​.earthwave​.co​.uk​/static​/docs​/index​.html","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"mXmibr7u1K"}],"urlSource":"https://specklia.earthwave.co.uk/static/docs/index.html","key":"N4fUZGCRC2"}],"key":"id6N5AZHeK"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Once an API key has been generated, please save it in a file named “specklia_api_key.txt”.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"UaV1u2fwmr"}],"key":"RNORUNsy4I"}],"key":"l1GNQiCy92"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Prepare the environment","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UFTSSRB0W6"}],"identifier":"prepare-the-environment","label":"Prepare the environment","html_id":"prepare-the-environment","implicit":true,"key":"DvF1Ad8ABn"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Installing some additional packages not installed in the conda environment by default.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FDOIWAUraZ"}],"key":"YdQvhH5JdF"}],"key":"LwiZSR3UnP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"!pip3 install --upgrade specklia\n!pip3 install matplotlib\n!pip3 install contextily","key":"xqXHlswGMN"},{"type":"outputs","id":"zyyW4HB5ZqrGnAlafGhHA","children":[],"key":"Gitc090KRw"}],"key":"RQo61ZCDnF"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Import the client library and create an instance of the client with a key obtained from ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Uj1yWd4A9F"},{"type":"link","url":"https://specklia.earthwave.co.uk/","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"https://​specklia​.earthwave​.co​.uk/","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BjtniyoGq3"}],"urlSource":"https://specklia.earthwave.co.uk/","key":"eOwaCXrxD8"}],"identifier":"import-the-client-library-and-create-an-instance-of-the-client-with-a-key-obtained-from-https-specklia-earthwave-co-uk","label":"Import the client library and create an instance of the client with a key obtained from https://specklia.earthwave.co.uk/","html_id":"import-the-client-library-and-create-an-instance-of-the-client-with-a-key-obtained-from-https-specklia-earthwave-co-uk","implicit":true,"key":"J6frRRAhCR"}],"visibility":"show","key":"WtQha8PckO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import sys\nsys.path.append(\"./.local/lib/python3.10/site-packages\")\nfrom specklia import Specklia\n\nwith open(\"specklia_api_key.txt\", \"r\") as file:\n    api_key = file.read()\n\n# Temporary non-official url for demo!\nclient = Specklia(api_key)","key":"cM5NbOKzpC"},{"type":"outputs","id":"kq-ZIoMC3LslIe-Z6NeLo","children":[],"key":"fs97x6eMq8"}],"key":"HEqLdCRLEI"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Example: query the client for available datasets","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qlsFbrDfNm"}],"identifier":"example-query-the-client-for-available-datasets","label":"Example: query the client for available datasets","html_id":"example-query-the-client-for-available-datasets","implicit":true,"key":"hQWLuDb6E2"}],"visibility":"show","key":"WLquyiyvhK"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"datasets = client.list_datasets()\ndatasets","visibility":"show","key":"wjHAsLroav"},{"type":"outputs","id":"TRakx-AW_POwLEwbfUFoe","children":[],"visibility":"show","key":"mjzareCanJ"}],"visibility":"show","key":"OdduUiDqGY"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now query the client for the CryoSat-2 Gridded EOLIS Elevation Product","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DRqv2wNr09"}],"identifier":"now-query-the-client-for-the-cryosat-2-gridded-eolis-elevation-product","label":"Now query the client for the CryoSat-2 Gridded EOLIS Elevation Product","html_id":"now-query-the-client-for-the-cryosat-2-gridded-eolis-elevation-product","implicit":true,"key":"JA1CGWFbAc"}],"visibility":"show","key":"bObDujTOx7"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import shapely\nfrom datetime import datetime\n\nsvalbard_polygon = shapely.Polygon(([15, 81], [28, 80.5], [29, 79.03], [14.57, 78.9], [15, 81]))\n\n\ndataset_name = 'CryoTEMPO-EOLIS Gridded Product'\navailable_datasets = client.list_datasets()\ngridded_product_dataset = available_datasets[\n    available_datasets['dataset_name'] == dataset_name].iloc[0]\n\ngridded_product_data_2012, sources = client.query_dataset(\n    dataset_id=gridded_product_dataset['dataset_id'],\n    epsg4326_polygon=svalbard_polygon,\n    min_datetime=datetime(2012, 1, 1),\n    max_datetime=datetime(2012, 1, 31, 23, 59, 59),\n    columns_to_return=['timestamp', 'elevation', 'x', 'y'],\n    additional_filters=[],\n    source_information_only=False)\n\nprint(\n    f'Query complete, {len(gridded_product_data_2012)} points returned, drawn from {len(sources)} original sources.')","visibility":"show","key":"Fy4EXysUek"},{"type":"outputs","id":"Cnt1G4i-46-I7fgR67wZA","children":[],"visibility":"show","key":"hjCSP16hTG"}],"visibility":"show","key":"YrDVxJnVJ5"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Convert the dataframe to a 2-D Array","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A2ED1nuvgg"}],"identifier":"convert-the-dataframe-to-a-2-d-array","label":"Convert the dataframe to a 2-D Array","html_id":"convert-the-dataframe-to-a-2-d-array","implicit":true,"key":"u9ABGFsV91"}],"visibility":"show","key":"liSM4b7FwS"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import pandas as pd\nimport numpy as np\n\nsource_information = sources[0]['source_information']\nresolution = source_information['geospatial_resolution']\nprojection = source_information['geospatial_projection']\n\ndf = gridded_product_data_2012.copy(deep=True)\ndf = df[['x','y','elevation']]\ndf['elevation'] = df['elevation'].astype(float)\n\npoint_extent = (df.x.min(),\n                df.y.min(),\n                df.x.max(),\n                df.y.max())\narray_extent = (point_extent[0] - resolution / 2,\n                point_extent[1] - resolution / 2,\n                point_extent[2] + resolution / 2,\n                point_extent[3] + resolution / 2)\n\n# Build unique x and y points\nxs = np.arange(point_extent[0], point_extent[2] + 1, resolution)\nys = np.arange(point_extent[3], point_extent[1] - 1, -resolution)\n\nxs, ys = np.repeat(xs, len(ys)), np.tile(ys, len(xs))\ndf_grid = pd.DataFrame(data={'x': xs, 'y': ys})\n\ndf_dense = pd.merge(df_grid, df, on=['x', 'y'], how='left')\n\ndata_array = df_dense.pivot(index='y', columns='x', values='elevation').values\ndata_array = data_array[::-1]","visibility":"show","key":"SIeghMK3CM"},{"type":"outputs","id":"5CYo8YVN3PyzT1rlav_Hn","children":[],"visibility":"show","key":"Yihro450Ep"}],"visibility":"show","key":"wP0rJb9es3"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"View the data with a simple plot","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UHjaG6iqDF"}],"identifier":"view-the-data-with-a-simple-plot","label":"View the data with a simple plot","html_id":"view-the-data-with-a-simple-plot","implicit":true,"key":"oC2Smayvi0"}],"key":"EXUqg43yiM"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import matplotlib.pyplot as plt\nfrom matplotlib.colors import TwoSlopeNorm\nfrom mpl_toolkits.axes_grid1 import make_axes_locatable\nimport contextily as ctx\n\nfig, ax = plt.subplots()\nim = ax.imshow(data_array, cmap='viridis', extent=[array_extent[0], array_extent[2], array_extent[1], array_extent[3]], interpolation='none', origin='upper')\n# ctx.add_basemap(ax, source=ctx.providers.Esri.WorldImagery, crs=3413)\n\nax.set_xlabel(\"Easting (m)\")\nax.set_ylabel(\"Northing (m)\")\ndivider = make_axes_locatable(ax)\ncax = divider.append_axes(\"right\", size=\"5%\", pad=0.05)\ncb = fig.colorbar(im, ax=ax, cax=cax)\ncb.set_label('Elevation (m)')\nfig.suptitle('CryoSat-2 EOLIS Gridded Elevation\\nProduct for Austfonna Svalbard', fontweight='bold')\n","visibility":"show","key":"kfQXeG3LRk"},{"type":"outputs","id":"Vac_-jG-YfXnIC7xs97jA","children":[],"visibility":"show","key":"e5WToEAKwP"}],"visibility":"show","key":"DpYyaP1mY5"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Save in an xcube compatible format","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vicH5yNsep"}],"identifier":"save-in-an-xcube-compatible-format","label":"Save in an xcube compatible format","html_id":"save-in-an-xcube-compatible-format","implicit":true,"key":"ranXg6SmnB"}],"key":"G8dz6w9epo"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import netCDF4\nfrom rasterio.crs import CRS\nimport numpy as np\nimport xarray as xr\nfrom xcube.core.chunk import chunk_dataset\nfrom xcube.core.store import new_data_store\n\n# EPSG:3413\nproj4_code = \"+proj=stere +lat_0=90 +lat_ts=70 +lon_0=-45 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs\"\n\n# resolution = resolution\nbounding_box = array_extent\n\ndata = data_array\n\nwith netCDF4.Dataset('tmp.nc', 'w', diskless=True) as nc:\n\n    # Create dimensions\n    nc.createDimension('y', data.shape[0])\n    nc.createDimension('x', data.shape[1])\n\n    # Create variables\n    y_var = nc.createVariable('y', np.float64, ('y'))\n    # lat_var.units = 'metres_north'\n    y_var.standard_name = 'North'\n    y_var.axis = 'y'\n\n    x_var = nc.createVariable('x', np.float64, ('x'))\n    # lon_var.units = 'metres_east'\n    x_var.standard_name = 'East'\n    x_var.axis = 'x'\n\n    var = nc.createVariable('data', \"float32\", ('y', 'x'), fill_value=9999)\n    var.units = 'm'\n    var.long_name = 'EOLIS Elevation'\n    var.short_name = 'EOLIS Elevation'\n\n    # Set up CRS\n    if proj4_code is not None:\n        crs_gris = CRS.from_proj4(proj4_code)\n        nc_crs = nc.createVariable('spatial_ref', 'i4')\n        nc_crs.spatial_ref = crs_gris.to_wkt()\n        var.grid_mapping = 'spatial_ref'\n\n    y = np.arange(bounding_box[1] + resolution / 2.0, bounding_box[3], resolution)\n    x = np.arange(bounding_box[0] + resolution / 2.0, bounding_box[2], resolution)\n\n    # Flip axis if y-affine negative.\n    # y_var[:] = y[::-1]\n    y_var[:] = y\n\n    x_var[:] = x\n    var[:, :] = data\n\n    chunk_size=256\n    store = new_data_store('file', root='./')\n    dataset = xr.open_dataset(xr.backends.NetCDF4DataStore(nc))\n\n    dataset.variables['data'].attrs['4d_viewer_layer_type'] = 'heatmap'  # or heightmap\n    dataset.attrs['4d_viewer_ui_path'] = '/PolarTEP/'\n\n    chunked_dataset = chunk_dataset(dataset, dict(y=chunk_size, x=chunk_size), format_name='zarr')\n\n    base_name = \"elevation-cryosat-2\"\n    store.write_data(chunked_dataset, f'{base_name}.zarr', replace=True)\n    store.write_data(chunked_dataset, f\"{base_name}.levels\", replace=True, base_dataset_id=f'{base_name}.zarr', agg_methods=\"first\")","visibility":"show","key":"fJYLy9fSpo"},{"type":"outputs","id":"k5Ati8_bsdswzZwd1Ss3p","children":[],"visibility":"show","key":"ffKTSGi5U0"}],"visibility":"show","key":"hKRgC1IxDj"}],"key":"KWC5oSUnUD"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"PolarTEP Notebooks","url":"/","group":"PolarTEP Notebooks"},"next":{"title":"Ccadi U C3","url":"/notebooks/ccadi-uc3","group":"Notebooks"}}},"domain":"http://localhost:3000"}